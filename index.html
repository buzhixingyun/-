<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <!-- ç¦ç”¨ç¼©æ”¾ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒï¼Œè§£å†³ iOS ç‚¹å‡»å»¶è¿Ÿ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Merry Christmas! ğŸ„</title>  
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">  
  
    <style>  
        /* --- 1. æ ¸å¿ƒé…è‰²ä¸åŸºç¡€è®¾ç½® --- */  
        :root {  
            --bg-color: #FFFBF0;        
            --primary: #FF8FA3;         
            --secondary: #B5EAD7;       
            --text-color: #D4A373;      
            --accent: #FFE577;          
            --card-bg: #FFFFFF;  
            --paper-color: #FFF8E7;  
        }  
  
        * { margin: 0; padding: 0; box-sizing: border-box; }  
  
        body {  
            background-color: var(--bg-color);
            color: var(--text-color);  
            font-family: 'Nunito', 'Ma Shan Zheng', sans-serif;   
            overflow: hidden;   
            height: 100vh; height: 100dvh; width: 100vw;  
            cursor: default;   
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 1s ease; /* èƒŒæ™¯è‰²å¹³æ»‘è¿‡æ¸¡ */
        }  

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 15px; font-family: 'Fredoka One'; color: var(--primary);
        }

        /* --- Background Layers --- */
        
        /* 1. åŸºç¡€èƒŒæ™¯å±‚ (æ¸å˜/å›¾æ ‡) */
        #bg-base-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
            background: linear-gradient(-45deg, #fff5f5, #e8f5e9, #fffde7, #fff0f5);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 1s ease;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. ç‰¹æ•ˆå±‚ (å›å¿†ä¸“å±åŠ¨ç”») */
        #theme-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden;
        }

        /* 3. å…¨å±€é›ªèŠ±å±‚ (é»˜è®¤æœ€ä¸Šå±‚ï¼Œä½†ä¸ä¼šæŒ¡ä½å¼¹çª—) */
        #snow-container {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            pointer-events: none; z-index: 2; 
        } 

        /* --- é¡¶éƒ¨è£…é¥° --- */
        .light-rope {
            position: fixed; top: -15px; left: 0; width: 100%; height: 60px;
            z-index: 100; pointer-events: none;
            display: flex; justify-content: space-around;
            overflow: hidden;
        }
        .light-bulb {
            position: relative; width: 16px; height: 36px; border-radius: 50%;
            background: #fff; margin-top: 10px;
            animation: swing 3s ease-in-out infinite alternate, glow 1.5s infinite alternate;
        }
        .light-bulb::before {
            content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 8px; background: #444;
        }
        .light-wire {
            position: absolute; top: -5px; left: 0; width: 100%; height: 25px;
            border-bottom: 2px solid #444; border-radius: 50%; z-index: 99;
        }
        .light-bulb:nth-child(2n) { background: #FF8FA3; box-shadow: 0 5px 15px rgba(255, 143, 163, 0.6); animation-delay: 0.2s; }
        .light-bulb:nth-child(2n+1) { background: #B5EAD7; box-shadow: 0 5px 15px rgba(181, 234, 215, 0.6); animation-delay: 0.5s; }
        .light-bulb:nth-child(3n) { background: #FFE577; box-shadow: 0 5px 15px rgba(255, 229, 119, 0.6); animation-delay: 0.8s; }
        @keyframes swing { 0% { transform: rotate(-3deg); } 100% { transform: rotate(3deg); } }
        @keyframes glow { 0% { opacity: 0.7; } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- Music Control --- */
        #music-control {
            position: fixed; top: 20px; right: 20px;
            width: 44px; height: 44px; 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 22px;
            transition: transform 0.2s;
            user-select: none;
        }
        #music-control:active { transform: scale(0.9); }
        #music-control.playing { animation: spin 4s linear infinite; color: var(--primary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
  
        /* --- Stage Layout --- */  
        .overlay-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s, backdrop-filter 0.8s;
            opacity: 0; visibility: hidden;
            backdrop-filter: blur(0px);
            -webkit-backdrop-filter: blur(0px);
            z-index: 500;
        }
        .overlay-stage.active { 
            opacity: 1; visibility: visible; 
            backdrop-filter: blur(3px); /* ç¨å¾®æ¨¡ç³ŠèƒŒæ™¯ï¼Œçªå‡ºæ–‡å­— */
            -webkit-backdrop-filter: blur(3px);
        }

        /* --- Dialog Box --- */
        .dialog-box {  
            background-color: var(--paper-color);  
            width: 88%; max-width: 480px; padding: 35px 30px; 
            border-radius: 24px;  
            border: 3px solid var(--text-color);  
            box-shadow: 8px 8px 0px rgba(212, 163, 115, 0.4);  
            position: relative; 
            max-height: 85vh; overflow-y: auto; 
            transform: scale(0.9) translateY(20px); opacity: 0;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.6s ease;
            /* ä¿è¯å¯¹è¯æ¡†åœ¨ç‰¹æ•ˆä¹‹ä¸Š */
            z-index: 501;
        }
        .overlay-stage.active .dialog-box { transform: scale(1) translateY(0); opacity: 1; }
  
        .dialog-pin {  
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);  
            width: 16px; height: 16px; background: var(--primary); border-radius: 50%;  
            box-shadow: inset 2px 2px 4px rgba(255,255,255,0.6);  
        }  
        .dialog-content {  
            margin-top: 20px; font-family: 'Ma Shan Zheng', cursive; font-size: 1.3rem;  
            line-height: 1.8; color: #5d4037; text-align: left; min-height: 80px;
        }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: var(--primary); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .action-btn {  
            background-color: var(--primary); color: white;  
            font-family: 'Fredoka One'; font-size: 1.1rem; letter-spacing: 1px;
            padding: 12px 32px; border: none; border-radius: 50px;  
            margin-top: 25px; cursor: pointer; float: right;  
            box-shadow: 0 4px 0 #d86c7f;  
            transition: transform 0.1s, box-shadow 0.1s;
            user-select: none;
        }  
        .action-btn:active { transform: translateY(4px); box-shadow: none; }  
        .action-btn.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

        /* --- Heart Animation Layer --- */  
        #game-layer {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 600; pointer-events: none;   
        }  
        .msg-box {  
            position: absolute; width: 60px; height: 60px; 
            background: white; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center;  
            text-align: center; padding: 2px; 
            font-size: 15px; font-weight: bold; color: #8d6e63; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);  
            font-family: 'Ma Shan Zheng', cursive; 
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 0; transform: scale(0);
        }  
        .msg-box:nth-child(4n+1) { background: #FFD1DC; color: #fff; }  
        .msg-box:nth-child(4n+2) { background: #E2F0CB; color: #779966; }  
        .msg-box:nth-child(4n+3) { background: #FFF5BA; color: #D4A373; }  
        .msg-box:nth-child(4n+4) { background: #FFFFFF; color: #FF8FA3; border: 2px solid #FF8FA3; }  

        /* --- Final Gift Card --- */  
        .welcome-card {  
            background: var(--card-bg); width: 90%; max-width: 450px; padding: 40px 30px;  
            border-radius: 30px; border: 4px dashed var(--primary);  
            box-shadow: 0 20px 50px rgba(212, 163, 115, 0.2); text-align: center;  
            transform: translateY(40px); opacity: 0; transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);   
        }  
        .overlay-stage.active .welcome-card { transform: translateY(0); opacity: 1; }  
        .ribbon { position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: var(--secondary); border-radius: 50%; opacity: 0.5; z-index: -1; }  
        .memory-lane { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; margin-top: 20px;}  
        .polaroid { background: white; padding: 6px 6px 20px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: rotate(-5deg); width: 90px; border: 1px solid #f0f0f0; }  
        .polaroid:nth-child(2) { transform: rotate(5deg) translateY(8px); }  
        .polaroid-img { width: 100%; height: 65px; background-color: #FFD1DC; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }  

        /* --- Final Scene --- */  
        #main-scene {  
            position: relative; z-index: 10; display: flex; flex-direction: column;  
            align-items: center; justify-content: center; height: 100%; text-align: center;  
            transition: filter 1s ease, opacity 1s; filter: blur(10px); opacity: 0; pointer-events: none;
        }  
        #main-scene.active { filter: blur(0); opacity: 1; pointer-events: auto; }  
        .snow-ground { position: fixed; bottom: -40px; left: 0; width: 100%; height: 120px; background: white; border-radius: 50% 50% 0 0 / 100% 100% 0 0; transform: scaleX(1.5); z-index: 2; }  
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(105vh) rotate(360deg); opacity: 0; } }  
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; pointer-events: none; } 
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 1s ease; }

        /* =========================================
           THEME ANIMATIONS (Unique for each memory)
           ========================================= */

        /* Theme 1: Sakura (åˆè¯†) */
        .fx-sakura { position: absolute; font-size: 1.5rem; animation: sakuraFall linear infinite; opacity: 0.8; }
        @keyframes sakuraFall { 0% { transform: translateY(-10vh) rotate(0deg) translateX(0); } 100% { transform: translateY(110vh) rotate(360deg) translateX(20px); } }

        /* Theme 2: Paper Plane (åˆ†äº«) */
        .fx-plane { position: absolute; font-size: 2.5rem; animation: planeFly linear infinite; opacity: 0.9; }
        @keyframes planeFly { 
            0% { transform: translate(-20vw, 10vh) rotate(10deg) scale(0.5); opacity: 0; } 
            20% { opacity: 1; }
            100% { transform: translate(120vw, -30vh) rotate(-10deg) scale(1); opacity: 1; } 
        }

        /* Theme 3: Gaming (æ¸¸æˆ) */
        /* æ¸¸æˆä¸»é¢˜éœ€è¦æ·±è‰²èƒŒæ™¯é…åˆ */
        .fx-game-icon { position: absolute; font-size: 3rem; animation: gamePop infinite alternate; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
        .fx-game-vs { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15rem; font-weight: 900; color: rgba(255,255,255,0.05); font-family: 'Fredoka One'; animation: pulseVs 2s infinite; }
        @keyframes gamePop { 0% { transform: scale(1) rotate(-5deg); } 100% { transform: scale(1.1) rotate(5deg); } }
        @keyframes pulseVs { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } }

        /* Theme 4: Warmth (æ”¯æ’‘) */
        .fx-warm-glow { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80vw; height: 80vw; background: radial-gradient(circle, rgba(255, 165, 0, 0.3) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%; animation: warmPulse 4s infinite ease-in-out;
        }
        @keyframes warmPulse { 0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); } }

        /* Theme 5: Laughter (æ¬¢ç¬‘) */
        .fx-laugh { position: absolute; font-size: 2.5rem; animation: floatBubble linear infinite; }
        @keyframes floatBubble { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }

        /* Theme 6: Winter (è¿‡å†¬) */
        .fx-frost { position: absolute; inset: 0; box-shadow: inset 0 0 100px rgba(200, 230, 255, 0.8); pointer-events: none; z-index: 10; }

        /* Theme 7: Stars (è®¸æ„¿) */
        .fx-star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
        .fx-shooting-star { 
            position: absolute; width: 100px; height: 2px; background: linear-gradient(90deg, white, transparent);
            transform: rotate(-45deg); animation: shootStar 3s linear infinite; opacity: 0;
        }
        @keyframes twinkle { 0% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }
        @keyframes shootStar { 0% { transform: translate(0, 0) rotate(-45deg); opacity: 1; } 20% { opacity: 1; } 100% { transform: translate(-50vw, 50vh) rotate(-45deg); opacity: 0; } }

        /* Theme 8: Balloons (é™ªä¼´) */
        .fx-balloon { position: absolute; font-size: 3rem; animation: balloonRise linear infinite; }
        @keyframes balloonRise { 0% { transform: translateY(110vh) translateX(0); } 50% { transform: translateY(50vh) translateX(20px); } 100% { transform: translateY(-20vh) translateX(-20px); } }

        /* Theme 9: Golden (ç¥ç¦) */
        .fx-gold { position: absolute; width: 6px; height: 6px; background: #FFD700; border-radius: 50%; animation: goldRain linear infinite; box-shadow: 0 0 5px #FFD700; }
        @keyframes goldRain { 0% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

    </style>  
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>  
<body>  
    
    <!-- èµ„æºåŠ è½½é¡µ -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading Memories...</div>
    </div>

    <!-- é¡¶éƒ¨å½©ç¯è£…é¥° -->
    <div class="light-rope">
        <div class="light-wire"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
    </div>

    <!-- 0. åŸºç¡€æ¸å˜èƒŒæ™¯ -->
    <div id="bg-base-layer"></div>

    <!-- 1. ä¸»é¢˜ç‰¹æ•ˆå±‚ (å›å¿†æ—¶åŠ¨æ€å˜åŒ–) -->
    <div id="theme-layer"></div>

    <!-- 2. å…¨å±€é›ªèŠ±å±‚ -->
    <div id="snow-container"></div>  

    <!-- é—ªå…‰è½¬åœºå±‚ -->
    <div id="flash-overlay"></div>

    <!-- èƒŒæ™¯éŸ³ä¹ (é¢„åŠ è½½) -->
    <audio id="bgm" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/holiday/jingle_bells.ogg" type="audio/ogg">
    </audio>
    <div id="music-control" onclick="toggleMusic(event)">ğŸµ</div>
  
    <!-- åºç«  -->  
    <div id="stage-0-intro" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <div class="dialog-content" id="intro-text"></div>  
            <button class="action-btn disabled" id="btn-intro" onclick="startMemories()">å¼€å¯å›å¿† &gt;</button>  
        </div>  
    </div>  
  
    <!-- å›å¿†æ’­æ”¾å™¨ -->  
    <div id="stage-1-memory" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 id="mem-title" style="color: #D4A373; font-size: 1.4rem; font-family: 'Fredoka One';"></h3>  
            <div class="dialog-content typing-cursor" id="mem-text"></div>  
            <button class="action-btn disabled" id="btn-mem" onclick="nextMemory()">ä¸‹ä¸€æ­¥ &gt;</button>  
        </div>
    </div>  
  
    <!-- æ¸¸æˆå¼•å¯¼ -->  
    <div id="stage-2-invite" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <div class="dialog-content" id="invite-text"></div>  
            <button class="action-btn disabled" id="btn-invite" onclick="startHeartAnimation()">  
                æ¥æ”¶ç¥ç¦ âœ¨  
            </button>  
        </div>  
    </div>  
  
    <!-- çˆ±å¿ƒåŠ¨ç”»å±‚ -->  
    <div id="game-layer"></div>  
  
    <!-- ç¤¼ç‰©å¡ç‰‡ -->  
    <div id="stage-3-card" class="overlay-stage">  
        <div class="welcome-card">  
            <div class="ribbon"></div>  
            <h2 class="card-title">To: äº²çˆ±çš„ä½  âœ¨</h2>  
            <p class="card-text" style="font-size: 1.2rem;">  
                é›†é½å•¦ï¼<br>æ¯ä¸€ä¸ªæ–¹å—éƒ½æ˜¯æˆ‘çš„å¿ƒæ„ã€‚<br>åœ£è¯å¿«ä¹ï¼  
            </p>  
            <div class="memory-lane">  
                <div class="polaroid"><div class="polaroid-img">ğŸ¬</div></div>  
                <div class="polaroid"><div class="polaroid-img">ğŸŒŸ</div></div>  
            </div>  
            <button class="action-btn" style="float:none;" onclick="revealFinal()">æ‹†å¼€ç¤¼ç‰© ğŸ</button>  
        </div>  
    </div>  
  
    <!-- æœ€ç»ˆåœºæ™¯ -->  
    <div id="main-scene">  
        <h1 style="font-family: 'Fredoka One'; font-size: 3.2rem; color: #FF8FA3; margin-bottom: 15px; text-shadow: 2px 2px 0px #fff;">Merry Christmas!</h1>  
        <div style="font-size: 5rem; cursor: pointer; animation: float 3s infinite ease-in-out;">ğŸ¦Œ</div>  
        <p style="margin-top: 20px; color: #D4A373; font-weight: bold; font-size: 1.2rem;">å±äºä½ çš„å¯çˆ±å†¬å¤©</p>  
    </div>  
    <div class="snow-ground"></div>  
  
    <script>  
        // ================= æ•°æ®é…ç½® =================  
        
        const INTRO_TEXT = "è¿™æ˜¯æˆ‘ä»¬è®¤è¯†åæˆ‘é™ªä½ åº¦è¿‡çš„ç¬¬ä¸€ä¸ªåœ£è¯èŠ‚\nè°¨ä»¥æ­¤çºªå¿µæˆ‘ä»¬çš„å‹è°Š\nåœ¨è¿™ä¸ªå¯’å†·çš„å†¬å¤©ï¼Œå¸Œæœ›å¯ä»¥ä¸ºä½ å¸¦æ¥ä¸€ä¸æ¸©æš–";
        const INVITE_TEXT = "Helloï¼Œåœ£è¯å¿«ä¹ï¼\nè¿™é‡Œæœ‰ä¸€ä»½ç‰¹åˆ«çš„ç¤¼ç‰©é€ç»™ä½ ã€‚\nå‡†å¤‡å¥½äº†å—ï¼Ÿ";

        const MESSAGES = [  
            "ğŸå¹³å®‰", "ğŸ’°æš´å¯Œ", "ğŸ€å¥½è¿", "â¤ï¸Love",   
            "âœ¨é—ªè€€", "ğŸ„Xmas", "ğŸç¤¼ç‰©", "ğŸ’ªåŠ æ²¹",   
            "ğŸ¬ç”œèœœ", "ğŸ±å¯çˆ±", "ğŸŒˆç¾å¥½", "ğŸš€ä¸Šå²¸",   
            "ğŸ‰æ¬¢åº†", "â„ï¸çº¯æ´", "ğŸŒŸå¸Œæœ›", "ğŸ–ï¸è‡ªç”±",   
            "ğŸ˜„å¼€å¿ƒ", "ğŸŸé”¦é²¤", "ğŸ æ¸©é¦¨", "ğŸ‘­å‹è°Š",  
            "ğŸ°å¹¸ç¦", "ğŸŒ™æ™šå®‰", "ğŸ§¸é™ªä¼´", "ğŸ¶å¿«ä¹"  
        ];  

        const MEMORIES = [
            { t: "(1/9) ğŸŒ±", c: "è¿˜è®°å¾—æˆ‘ä»¬åˆšè®¤è¯†çš„æ—¶å€™å—ï¼Ÿ\né‚£æ—¶è™½ç„¶æœ‰äº›æ‹˜è°¨ï¼Œ\nä½†æ¯ä¸€æ¬¡å¯¹è¯éƒ½è®©æˆ‘è§‰å¾—ç‰¹åˆ«æŠ•ç¼˜ã€‚\nåƒæ˜¯æ˜¥é£å¹è¿›äº†å¿ƒé‡Œã€‚", theme: 'sakura' },
            { t: "(2/9) ğŸ“±", c: "åæ¥æˆ‘ä»¬è¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œ\nå¼€å§‹åˆ†äº«å½¼æ­¤çš„å–œæ€’å“€ä¹ï¼Œ\nå“ªæ€•æ˜¯ç”Ÿæ´»é‡Œçš„èŠéº»å°äº‹ï¼Œ\nä¹Ÿæ€»æƒ³ç¬¬ä¸€æ—¶é—´å‘Šè¯‰ä½ ã€‚", theme: 'planes' },
            { t: "(3/9) ğŸ®", c: "æœ€å¼€å¿ƒçš„å°±æ˜¯å’Œä½ ä¸€èµ·æ‰“æ¸¸æˆï¼\nä¸ç®¡æ˜¯ç‹è€…è£è€€è¿˜æ˜¯å’Œå¹³ç²¾è‹±...\næ¯ä¸€æ¬¡ç»„é˜Ÿå¼€é»‘ï¼Œ\néƒ½æ˜¯æˆ‘ä»¬ä¸“å±çš„å¿«ä¹æ—¶å…‰ï¼", theme: 'gaming' },
            { t: "(4/9) ğŸ’ª", c: "å½“ç„¶ä¹Ÿæœ‰ä¸€èµ·emoçš„æ—¶å€™ï¼Œ\näº’ç›¸åæ§½ç”Ÿæ´»çš„ä¸æ˜“ã€å·¥ä½œçš„çƒ¦æ¼ã€‚\nä½†åªè¦äº’ç›¸æ‰“æ‰“æ°”ï¼Œ\nå¥½åƒå°±åˆæœ‰äº†ç»§ç»­å‡çº§æ‰“æ€ªçš„åŠ¨åŠ›ã€‚", theme: 'warmth' },
            { t: "(5/9) ğŸ˜‚", c: "è°¢è°¢ä½ æ€»æ˜¯èƒ½æ¥ä½æˆ‘çš„å¥‡å¥‡æ€ªæ€ªï¼Œ\né‚£äº›åªæœ‰æˆ‘ä»¬æ‡‚çš„æ¢—ï¼Œ\næ¯æ¬¡æƒ³èµ·æ¥éƒ½ä¼šå¿ä¸ä½å˜´è§’ä¸Šæ‰¬ã€‚\nå’Œä½ èŠå¤©çœŸçš„è¶…çº§è½»æ¾å¿«ä¹ã€‚", theme: 'laugh' },
            { t: "(6/9) â„ï¸", c: "ä¸çŸ¥ä¸è§‰ï¼Œ\nåˆä¸€èµ·èµ°è¿‡äº†ä¸€ä¸ªæ˜¥å¤ç§‹å†¬ï¼Œ\nè¿æ¥äº†è¿™ä¸ªæµªæ¼«çš„åœ£è¯èŠ‚ã€‚\nå› ä¸ºæœ‰ä½ ï¼Œè¿™ä¸ªå†¬å¤©å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆå†·äº†ã€‚", theme: 'winter' },
            { t: "(7/9) âœ¨", c: "åœ£è¯èŠ‚åˆ°äº†ï¼Œ\næƒ³æŠŠæ˜Ÿæ˜Ÿæ‘˜ä¸‹æ¥é€ç»™ä½ ï¼Œ\næƒ³æŠŠä¸–ç•Œä¸Šæœ€ç¾å¥½çš„ç¥ç¦éƒ½ç»™ä½ ã€‚\nå¸Œæœ›ä½ æ¯å¤©éƒ½èƒ½é‡è§å±äºä½ çš„å°ç¡®å¹¸ã€‚", theme: 'stars' },
            { t: "(8/9) ğŸˆ", c: "è°¢è°¢ä½ å‡ºç°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œ\næˆä¸ºæˆ‘ç‰¹åˆ«çš„æœ‹å‹ã€‚\nå¸Œæœ›åœ¨æœªæ¥çš„æ—¥å­é‡Œï¼Œ\næˆ‘ä»¬å¯ä»¥ç»§ç»­ä¸€èµ·å¤§ç¬‘ï¼Œä¸€èµ·å¯å¯çˆ±çˆ±ã€‚", theme: 'balloons' },
            { t: "(9/9) ğŸ„", c: "æœ€åï¼Œ\näº²çˆ±çš„å°èƒ¡åŒå­¦ï¼Œ\næ„¿ä½ æ°¸è¿œè¢«çˆ±åŒ…å›´ï¼Œä¸‡äº‹èƒœæ„ï¼\nåœ£è¯å¿«ä¹ï¼Œä¸æ­¢åœ£è¯ï¼Œæ¯å¤©éƒ½å¿«ä¹ï¼", theme: 'gold' }
        ];
  
        // ================= ç³»ç»Ÿå˜é‡ =================  
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        let currentMemIndex = 0;

        // ================= åˆå§‹åŒ– =================  
        window.onload = async () => {
            await document.fonts.ready;
            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 800);

            showStage('stage-0-intro');
            spawnBgIcon(); // ç®€å•çš„é¦–é¡µæ¼‚æµ®ç‰©
            
            setTimeout(() => {
                typeWriter(document.getElementById('intro-text'), INTRO_TEXT, () => {
                    enableBtn('btn-intro');
                });
            }, 800);

            setInterval(createSnow, 200);
        };

        // ================= ç‰¹æ•ˆå¼•æ“ (Theme Engine) =================  
        function applyTheme(theme) {
            const layer = document.getElementById('theme-layer');
            const body = document.body;
            layer.innerHTML = ''; // æ¸…é™¤æ—§ç‰¹æ•ˆ
            
            // é»˜è®¤èƒŒæ™¯
            body.style.backgroundColor = '#FFFBF0';
            document.getElementById('bg-base-layer').style.opacity = '1';

            switch(theme) {
                case 'sakura': // 1. æ¨±èŠ±
                    createParticles(layer, 'ğŸŒ¸', 20, 'fx-sakura', 5, 10);
                    break;
                case 'planes': // 2. çº¸é£æœº
                    createParticles(layer, 'âœˆï¸', 6, 'fx-plane', 8, 15);
                    break;
                case 'gaming': // 3. æ¸¸æˆ (æ·±è‰²ç”µç«é£)
                    document.getElementById('bg-base-layer').style.opacity = '0.1'; // å‹æš—èƒŒæ™¯
                    body.style.backgroundColor = '#1a103c'; // æ·±è“ç´«
                    // VS æ°´å°
                    const vs = document.createElement('div');
                    vs.className = 'fx-game-vs'; vs.innerText = 'VS';
                    layer.appendChild(vs);
                    // æ¸¸æˆå…ƒç´ 
                    const icons = ['ğŸ®', 'âš¡', 'ğŸ”¥', 'ğŸ‘¾', 'âš”ï¸', 'ğŸ†'];
                    for(let i=0; i<15; i++) {
                        const p = document.createElement('div');
                        p.className = 'fx-game-icon';
                        p.innerText = icons[Math.floor(Math.random()*icons.length)];
                        p.style.left = Math.random()*90 + 5 + 'vw';
                        p.style.top = Math.random()*90 + 5 + 'vh';
                        p.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(p);
                    }
                    break;
                case 'warmth': // 4. æš–é˜³
                    document.getElementById('bg-base-layer').style.opacity = '0.2';
                    body.style.backgroundColor = '#2c3e50';
                    const glow = document.createElement('div');
                    glow.className = 'fx-warm-glow';
                    layer.appendChild(glow);
                    break;
                case 'laugh': // 5. æ¬¢ç¬‘
                    createParticles(layer, ['ğŸ˜‚','ğŸ¤£','ğŸ˜¹','ğŸ˜†'][Math.floor(Math.random()*4)], 15, 'fx-laugh', 4, 8, true);
                    break;
                case 'winter': // 6. è¿‡å†¬
                    const frost = document.createElement('div');
                    frost.className = 'fx-frost';
                    layer.appendChild(frost);
                    // åŠ å¤§é›ªé‡
                    for(let i=0; i<20; i++) setTimeout(createSnow, i*50);
                    break;
                case 'stars': // 7. æ˜Ÿç©º
                    document.getElementById('bg-base-layer').style.opacity = '0';
                    body.style.backgroundColor = '#0f172a'; // æ·±å¤œè“
                    // æ˜Ÿæ˜Ÿ
                    for(let i=0; i<50; i++) {
                        const s = document.createElement('div');
                        s.className = 'fx-star';
                        const sz = Math.random()*3 + 1 + 'px';
                        s.style.width = sz; s.style.height = sz;
                        s.style.left = Math.random()*100 + 'vw'; s.style.top = Math.random()*100 + 'vh';
                        s.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(s);
                    }
                    // æµæ˜Ÿ
                    for(let i=0; i<3; i++) {
                        const ss = document.createElement('div');
                        ss.className = 'fx-shooting-star';
                        ss.style.top = Math.random()*30 + 'vh';
                        ss.style.right = Math.random()*30 + 'vw';
                        ss.style.animationDelay = i*2 + 's';
                        layer.appendChild(ss);
                    }
                    break;
                case 'balloons': // 8. æ°”çƒ
                    createParticles(layer, 'ğŸˆ', 12, 'fx-balloon', 6, 12, true);
                    break;
                case 'gold': // 9. é‡‘è‰²
                    document.getElementById('bg-base-layer').style.opacity = '0.5';
                    body.style.backgroundColor = '#fffbe6';
                    for(let i=0; i<40; i++) {
                        const g = document.createElement('div');
                        g.className = 'fx-gold';
                        g.style.left = Math.random()*100 + 'vw';
                        g.style.animationDuration = Math.random()*2 + 3 + 's';
                        g.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(g);
                    }
                    break;
                default:
                    break;
            }
        }

        // ç²’å­ç”Ÿæˆè¾…åŠ©å‡½æ•°
        function createParticles(container, charOrArr, count, className, minDur, maxDur, randomizeChar=false) {
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = className;
                if(randomizeChar && Array.isArray(charOrArr)) {
                    p.innerText = charOrArr[Math.floor(Math.random()*charOrArr.length)];
                } else if (randomizeChar) {
                     // å¦‚æœä¼ å…¥æ˜¯å•å­—ç¬¦ä½†å¼€å¯éšæœº(æ°”çƒ)ï¼Œè¿™é‡Œå…¶å®ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé™¤éæœ‰é¢œè‰²å˜åŒ–
                     p.innerText = charOrArr; 
                     if(className === 'fx-laugh') p.innerText = ['ğŸ˜‚','ğŸ¤£','ğŸ˜¹','ğŸ˜†'][Math.floor(Math.random()*4)];
                     if(className === 'fx-balloon') p.style.filter = `hue-rotate(${Math.random()*360}deg)`;
                } else {
                    p.innerText = charOrArr;
                }
                
                p.style.left = Math.random() * 90 + 5 + 'vw';
                const dur = Math.random() * (maxDur - minDur) + minDur;
                p.style.animationDuration = dur + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        // ================= å¸¸è§„é€»è¾‘ =================  

        // 0. é¦–é¡µèƒŒæ™¯
        function spawnBgIcon() {
            const container = document.getElementById('bg-base-layer');
            const icons = ['ğŸ„', 'ğŸ…', 'ğŸ¦Œ', 'ğŸ', 'ğŸ””'];
            setInterval(() => {
                if(container.childElementCount > 10) return;
                const icon = document.createElement('div');
                icon.className = 'floating-icon'; // å¤ç”¨ä¹‹å‰çš„cssæˆ–inline
                icon.style.cssText = `position:absolute; font-size:3rem; opacity:0.15; filter:blur(2px); user-select:none; animation: floatUp 20s linear infinite;`;
                icon.innerText = icons[Math.floor(Math.random()*icons.length)];
                icon.style.left = Math.random()*90 + 'vw';
                container.appendChild(icon);
                setTimeout(()=>icon.remove(), 20000);
            }, 2000);
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(20deg); } }`;
            document.head.appendChild(style);
        }

        // 1. åœºæ™¯åˆ‡æ¢
        function showStage(id) {
            document.querySelectorAll('.overlay-stage').forEach(el => {
                if(el.classList.contains('active')) el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 800);
            });
            const target = document.getElementById(id);
            target.style.display = 'flex'; target.offsetHeight; target.classList.add('active');
        }

        // 2. æ‰“å­—æœº
        function typeWriter(element, text, onComplete) {
            element.innerHTML = ""; element.classList.add('typing-cursor');
            let i = 0;
            const t = setInterval(() => {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.innerHTML += (char === '\n' ? '<br>' : char);
                    i++;
                    element.parentElement.scrollTop = element.parentElement.scrollHeight;
                } else {
                    clearInterval(t);
                    element.classList.remove('typing-cursor');
                    if (onComplete) onComplete();
                }
            }, 50);
        }

        function enableBtn(id) { document.getElementById(id).classList.remove('disabled'); }

        // 3. éŸ³ä¹
        function toggleMusic(e) {
            e.stopPropagation();
            if (bgm.paused) {
                bgm.play(); musicBtn.classList.add('playing'); musicBtn.innerText = 'ğŸµ';
            } else {
                bgm.pause(); musicBtn.classList.remove('playing'); musicBtn.innerText = 'ğŸš«';
            }
        }

        // 4. å›å¿†æµç¨‹
        function startMemories() {
            if(bgm.paused) toggleMusic({stopPropagation:()=>{}});
            showStage('stage-1-memory');
            renderMemory(0);
        }

        function renderMemory(index) {
            currentMemIndex = index;
            const data = MEMORIES[index];
            const titleEl = document.getElementById('mem-title');
            const textEl = document.getElementById('mem-text');
            const btn = document.getElementById('btn-mem');

            // åº”ç”¨ä¸“å±ä¸»é¢˜
            applyTheme(data.theme);

            textEl.style.opacity = '0.5';
            setTimeout(()=> textEl.style.opacity = '1', 100);

            titleEl.innerText = data.t;
            btn.classList.add('disabled'); 

            typeWriter(textEl, data.c, () => {
                enableBtn('btn-mem');
            });
        }

        function nextMemory() {
            if (currentMemIndex < MEMORIES.length - 1) {
                renderMemory(currentMemIndex + 1);
            } else {
                // æ¸…é™¤å›å¿†ç‰¹æ•ˆï¼Œæ¢å¤é»˜è®¤ï¼Œè¿›å…¥Invite
                applyTheme('default');
                showStage('stage-2-invite');
                setTimeout(() => {
                    typeWriter(document.getElementById('invite-text'), INVITE_TEXT, () => {
                        enableBtn('btn-invite');
                    });
                }, 500);
            }
        }

        // 5. å…¨è‡ªåŠ¨çˆ±å¿ƒåŠ¨ç”»
        function startHeartAnimation() {
            const inviteStage = document.getElementById('stage-2-invite');
            inviteStage.classList.remove('active');
            
            const layer = document.getElementById('game-layer');
            layer.style.display = 'block'; 

            const w = window.innerWidth; const h = window.innerHeight;
            const cx = w / 2; const cy = h / 2;
            const scale = Math.min(w, h) < 400 ? 11 : 14; 
            const delay = 200; // èŠ‚å¥ç¨å¿«ä¸€ç‚¹

            MESSAGES.forEach((msg, i) => {
                const t = (i / MESSAGES.length) * 2 * Math.PI;
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                const targetX = (x * scale + cx) - 30;
                const targetY = (y * scale + cy) - 30;

                const box = document.createElement('div');
                box.className = 'msg-box';
                box.innerText = msg;
                box.style.left = (cx - 30) + 'px'; box.style.top = (cy - 30) + 'px';
                layer.appendChild(box);
                box.offsetHeight;

                setTimeout(() => {
                    box.style.left = targetX + 'px';
                    box.style.top = targetY + 'px';
                    box.style.opacity = '1';
                    box.style.transform = 'scale(1)';
                }, i * delay); 
            });

            const totalTime = (MESSAGES.length) * delay + 2000;
            setTimeout(finishGame, totalTime);
        }

        function finishGame() {
            document.getElementById('game-layer').style.display = 'none';
            showStage('stage-3-card');
        }

        function revealFinal() {
            const cardStage = document.getElementById('stage-3-card');
            cardStage.classList.remove('active');
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = '1';
            
            setTimeout(() => {
                cardStage.style.display = 'none';
                const mainScene = document.getElementById('main-scene');
                mainScene.classList.add('active');
                // ç»“å±€ä¹Ÿæ˜¯é‡‘è‰²ç‰¹æ•ˆ
                applyTheme('gold'); 
                setTimeout(() => { flash.style.opacity = '0'; }, 100);
            }, 800);
        }

        function createSnow() {
            const c = document.getElementById('snow-container');
            if (c.childElementCount > 40) return; 
            const s = document.createElement('div');
            s.classList.add('snowflake');
            const size = Math.random() * 8 + 5 + 'px';
            s.style.width = size; s.style.height = size;
            s.style.left = Math.random() * 100 + 'vw';
            s.style.opacity = Math.random() * 0.5 + 0.3;
            const d = Math.random() * 5 + 5 + 's';
            s.style.animation = `fall ${d} linear infinite`;
            c.appendChild(s);
            setTimeout(() => s.remove(), parseFloat(d) * 1000);
        }
    </script>  
</body>  
</html>
