<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <!-- ç¦ç”¨ç¼©æ”¾ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒï¼Œè§£å†³ iOS ç‚¹å‡»å»¶è¿Ÿ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Merry Christmas! ğŸ„</title>  
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">  
  
    <style>  
        /* --- 1. æ ¸å¿ƒé…è‰²ä¸åŸºç¡€è®¾ç½® --- */  
        :root {  
            --bg-color: #FFFBF0;        
            --primary: #FF8FA3;         
            --secondary: #B5EAD7;       
            --text-color: #D4A373;      
            --accent: #FFE577;          
            --card-bg: #FFFFFF;  
            --paper-color: #FFF8E7;  
        }  
  
        * { margin: 0; padding: 0; box-sizing: border-box; }  
  
        body {  
            background-color: var(--bg-color);
            color: var(--text-color);  
            font-family: 'Nunito', 'Ma Shan Zheng', sans-serif;   
            overflow: hidden;   
            height: 100vh; height: 100dvh; width: 100vw;  
            cursor: default;   
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 1.2s cubic-bezier(0.4, 0, 0.2, 1); /* èƒŒæ™¯è‰²ä¸æ»‘è¿‡æ¸¡ */
        }  

        /* --- Loading Screen (Optimized) --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        
        /* è·³åŠ¨çš„ç¤¼ç‰©å›¾æ ‡ */
        .loading-icon {
            font-size: 4.5rem;
            animation: bounceGift 1s infinite alternate ease-in-out;
            filter: drop-shadow(0 15px 15px rgba(255, 143, 163, 0.3));
            margin-bottom: 20px;
        }
        @keyframes bounceGift {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-15px) scale(1.1); }
        }

        /* è¿›åº¦æ¡å®¹å™¨ */
        .loading-bar-container {
            width: 200px; height: 10px; background: #FFF0F5;
            border-radius: 20px; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        /* è¿›åº¦æ¡æœ¬ä½“ */
        .loading-bar {
            width: 0%; height: 100%; 
            background: var(--primary);
            border-radius: 20px;
            transition: width 1.5s cubic-bezier(0.22, 0.61, 0.36, 1);
            /* æ¡çº¹åŠ¨ç”» */
            background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent);
            background-size: 20px 20px;
            animation: progressStripes 1s linear infinite;
        }
        @keyframes progressStripes { from { background-position: 20px 0; } to { background-position: 0 0; } }

        .loading-text {
            margin-top: 15px; font-family: 'Ma Shan Zheng'; 
            color: var(--text-color); font-size: 1.1rem; 
            opacity: 0.9; letter-spacing: 1px;
        }

        /* --- Background Layers --- */
        
        /* 1. åŸºç¡€èƒŒæ™¯å±‚ (æ¸å˜/å›¾æ ‡) */
        #bg-base-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
            background: linear-gradient(-45deg, #fff5f5, #e8f5e9, #fffde7, #fff0f5);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 1.5s ease;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. ç‰¹æ•ˆå±‚ (å›å¿†ä¸“å±åŠ¨ç”») */
        #theme-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden;
            transition: opacity 1s ease;
        }

        /* 3. å…¨å±€é›ªèŠ±å±‚ (é»˜è®¤æœ€ä¸Šå±‚ï¼Œä½†ä¸ä¼šæŒ¡ä½å¼¹çª—) */
        #snow-container {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            pointer-events: none; z-index: 2; 
        } 

        /* --- é¡¶éƒ¨è£…é¥° --- */
        .light-rope {
            position: fixed; top: -15px; left: 0; width: 100%; height: 60px;
            z-index: 100; pointer-events: none;
            display: flex; justify-content: space-around;
            overflow: hidden;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .light-rope.hidden { transform: translateY(-100px); }

        .light-bulb {
            position: relative; width: 16px; height: 36px; border-radius: 50%;
            background: #fff; margin-top: 10px;
            animation: swing 3s ease-in-out infinite alternate, glow 1.5s infinite alternate;
        }
        .light-bulb::before {
            content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 8px; background: #444;
        }
        .light-wire {
            position: absolute; top: -5px; left: 0; width: 100%; height: 25px;
            border-bottom: 2px solid #444; border-radius: 50%; z-index: 99;
        }
        .light-bulb:nth-child(2n) { background: #FF8FA3; box-shadow: 0 5px 15px rgba(255, 143, 163, 0.6); animation-delay: 0.2s; }
        .light-bulb:nth-child(2n+1) { background: #B5EAD7; box-shadow: 0 5px 15px rgba(181, 234, 215, 0.6); animation-delay: 0.5s; }
        .light-bulb:nth-child(3n) { background: #FFE577; box-shadow: 0 5px 15px rgba(255, 229, 119, 0.6); animation-delay: 0.8s; }
        @keyframes swing { 0% { transform: rotate(-3deg); } 100% { transform: rotate(3deg); } }
        @keyframes glow { 0% { opacity: 0.7; } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- Music Control --- */
        #music-control {
            position: fixed; top: 20px; right: 20px;
            width: 44px; height: 44px; 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 22px;
            transition: transform 0.2s;
            user-select: none;
        }
        #music-control:active { transform: scale(0.9); }
        #music-control.playing { animation: spin 4s linear infinite; color: var(--primary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
  
        /* --- Stage Layout (Container) --- */  
        .overlay-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            z-index: 500;
            /* é»˜è®¤éšè—çŠ¶æ€ */
            opacity: 0; visibility: hidden; pointer-events: none;
            backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
            /* è½¬åœºåŠ¨ç”»é…ç½® */
            transition: opacity 0.6s ease, backdrop-filter 0.6s ease, visibility 0.6s;
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .overlay-stage.active { 
            opacity: 1; visibility: visible; pointer-events: auto;
            backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
        }

        /* --- Dialog Box (Animated Content) --- */
        .dialog-box {  
            background-color: var(--paper-color);  
            width: 88%; max-width: 480px; padding: 35px 30px; 
            border-radius: 24px;  
            border: 3px solid var(--text-color);  
            box-shadow: 8px 8px 0px rgba(212, 163, 115, 0.4);  
            position: relative; 
            max-height: 85vh; overflow-y: auto; 
            z-index: 501;
            
            /* åˆå§‹çŠ¶æ€ï¼šç¨å¾®ç¼©å°å¹¶ä¸‹ç§» */
            transform: scale(0.8) translateY(30px); 
            opacity: 0;
            /* ç‰©ç†å¼¹ç°§å…¥åœºåŠ¨ç”» */
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.6s ease;
        }

        /* å¼¹çª—æ¿€æ´»ï¼šå›å¼¹åˆ°æ­£å¸¸å¤§å° */
        .overlay-stage.active .dialog-box { 
            transform: scale(1) translateY(0); 
            opacity: 1; 
        }
        
        /* å¼¹çª—ç¦»åœºï¼šç¨å¾®æ”¾å¤§å¹¶æ·¡å‡º (Zoom Out Fade) */
        .overlay-stage.exit .dialog-box {
            transform: scale(1.1) translateY(-10px);
            opacity: 0;
            transition: transform 0.5s ease-in, opacity 0.4s ease;
        }
  
        .dialog-pin {  
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);  
            width: 16px; height: 16px; background: var(--primary); border-radius: 50%;  
            box-shadow: inset 2px 2px 4px rgba(255,255,255,0.6);  
        }  
        .dialog-content {  
            margin-top: 20px; font-family: 'Ma Shan Zheng', cursive; font-size: 1.3rem;  
            line-height: 1.8; color: #5d4037; text-align: left; min-height: 80px;
        }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: var(--primary); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .action-btn {  
            background-color: var(--primary); color: white;  
            font-family: 'Fredoka One'; font-size: 1.1rem; letter-spacing: 1px;
            padding: 12px 32px; border: none; border-radius: 50px;  
            margin-top: 25px; cursor: pointer; float: right;  
            box-shadow: 0 4px 0 #d86c7f;  
            transition: transform 0.1s, box-shadow 0.1s;
            user-select: none;
        }  
        .action-btn:active { transform: translateY(4px); box-shadow: none; }  
        .action-btn.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

        /* --- Heart Animation Layer (Optimized) --- */  
        #game-layer {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 600; pointer-events: none;   
        }  
        .msg-box {  
            position: absolute; width: 60px; height: 60px; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            border-radius: 16px; 
            display: flex; align-items: center; justify-content: center;  
            text-align: center; padding: 2px; 
            font-size: 15px; font-weight: bold; color: #8d6e63; 
            /* ç»ç’ƒæ‹Ÿæ€é˜´å½± */
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.05), 
                inset 0 0 0 1px rgba(255,255,255,0.6),
                inset 0 2px 5px rgba(255,255,255,0.8);
            font-family: 'Ma Shan Zheng', cursive; 
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 0; transform: scale(0);
        }  
        /* æ‚¬æµ®å‘¼å¸åŠ¨ç”» */
        .msg-box.floating { animation: boxFloat 3s ease-in-out infinite alternate; }
        @keyframes boxFloat { 0% { transform: translateY(0) scale(1); } 100% { transform: translateY(-6px) scale(1.05); } }
        
        /* ç²’å­çˆ†ç‚¸ (çº¯CSSå®ç°) */
        .particle {
            position: absolute; width: 6px; height: 6px; border-radius: 50%;
            pointer-events: none; opacity: 0;
        }
        @keyframes explode { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* é¢œè‰²é…ç½® */
        .msg-box:nth-child(4n+1) { background: rgba(255, 209, 220, 0.95); color: #fff; }  
        .msg-box:nth-child(4n+2) { background: rgba(226, 240, 203, 0.95); color: #779966; }  
        .msg-box:nth-child(4n+3) { background: rgba(255, 245, 186, 0.95); color: #D4A373; }  
        .msg-box:nth-child(4n+4) { background: rgba(255, 255, 255, 0.95); color: #FF8FA3; border: 2px solid #FF8FA3; }  

        /* --- Final Gift Card --- */  
        .welcome-card {  
            background: var(--card-bg); width: 90%; max-width: 450px; padding: 40px 30px;  
            border-radius: 30px; border: 4px dashed var(--primary);  
            box-shadow: 0 20px 50px rgba(212, 163, 115, 0.2); text-align: center;  
            /* é»˜è®¤ä¸‹æ²‰éšè— */
            transform: translateY(60px) scale(0.9); opacity: 0; 
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);   
        }  
        .overlay-stage.active .welcome-card { transform: translateY(0) scale(1); opacity: 1; }  
        /* ç¦»åœº */
        .overlay-stage.exit .welcome-card { transform: scale(0.8) opacity(0); transition: all 0.5s ease; }

        .ribbon { position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: var(--secondary); border-radius: 50%; opacity: 0.5; z-index: -1; }  
        .memory-lane { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; margin-top: 20px;}  
        .polaroid { background: white; padding: 6px 6px 20px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: rotate(-5deg); width: 90px; border: 1px solid #f0f0f0; }  
        .polaroid:nth-child(2) { transform: rotate(5deg) translateY(8px); }  
        .polaroid-img { width: 100%; height: 65px; background-color: #FFD1DC; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }  

        /* --- Final Scene (Optimized) --- */  
        #main-scene {  
            position: relative; z-index: 10; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; /* Align elements to bottom */
            height: 100%; width: 100%;
            padding-bottom: 100px; /* Space for the snow ground */
            text-align: center;
            transition: opacity 1s ease, filter 1s ease; 
            filter: blur(10px); opacity: 0; pointer-events: none;
            overflow: hidden;
        }  
        #main-scene.active { filter: blur(0); opacity: 1; pointer-events: auto; }  
        
        /* Scene Header */
        .scene-header {
            position: absolute; top: 15%; width: 100%;
            animation: floatTitle 4s ease-in-out infinite;
            z-index: 20;
        }
        @keyframes floatTitle { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .final-title {
            font-family: 'Fredoka One'; font-size: 3.5rem; 
            color: #FF8FA3; 
            text-shadow: 3px 3px 0px #fff, 0 0 20px rgba(255, 143, 163, 0.4);
            margin-bottom: 10px;
        }
        .final-subtitle {
            color: #D4A373; font-weight: bold; font-size: 1.3rem;
            font-family: 'Ma Shan Zheng';
            background: rgba(255,255,255,0.6);
            padding: 6px 24px; border-radius: 20px;
            display: inline-block;
            backdrop-filter: blur(2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* Moon Animation */
        .moon-wrapper {
            position: absolute; top: 10%; right: 10%;
            z-index: 5; cursor: pointer;
            animation: moonFloat 6s ease-in-out infinite alternate;
            transition: transform 0.3s;
        }
        .moon-wrapper:active { transform: scale(0.9); }
        .moon { font-size: 5.5rem; filter: drop-shadow(0 0 25px rgba(255, 240, 200, 0.5)); }
        @keyframes moonFloat { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }

        /* Forest Background */
        .forest-layer {
            position: absolute; bottom: 110px; left: 0; width: 100%;
            display: flex; justify-content: space-around;
            pointer-events: none; z-index: 5; opacity: 0.9;
            font-size: 4rem; filter: blur(0.5px);
        }
        .tree-bg { transform: scale(0.8); opacity: 0.7; }

        /* Cabin Animation */
        .cabin-wrapper {
            position: absolute; bottom: 110px; left: 8%;
            z-index: 15; cursor: pointer;
            transition: transform 0.2s;
        }
        .cabin-wrapper:hover { transform: scale(1.05); }
        .cabin-wrapper:active { transform: scale(0.95); }
        .cabin { font-size: 5rem; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        
        .smoke-container { position: absolute; top: -20px; right: 10px; }
        .smoke {
            width: 12px; height: 12px; background: rgba(255,255,255,0.7);
            border-radius: 50%; position: absolute;
            animation: smokeRise 3s infinite; opacity: 0;
        }
        .smoke:nth-child(2) { animation-delay: 1.5s; }
        @keyframes smokeRise { 
            0% { transform: translateY(0) scale(1); opacity: 0.8; } 
            100% { transform: translateY(-50px) scale(2.5); opacity: 0; } 
        }

        /* Interactive Stage Area */
        .scene-stage {
            display: flex; align-items: flex-end; justify-content: center;
            gap: 8px; width: 100%; max-width: 800px;
            padding: 0 10px; z-index: 20;
            flex-wrap: nowrap;
        }

        /* Interactive Items */
        .interact-item {
            position: relative; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .interact-item:active { transform: scale(0.95); }
        .interact-item:hover { transform: translateY(-5px); }

        .interact-item .emoji { 
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.15));
            transition: filter 0.3s;
            line-height: 1;
        }
        .interact-item:hover .emoji { filter: drop-shadow(0 8px 15px rgba(0,0,0,0.2)) brightness(1.1); }

        .shadow {
            width: 70%; height: 12px; background: rgba(0,0,0,0.1);
            border-radius: 50%; margin-top: -5px;
            transition: all 0.3s;
        }
        .interact-item:hover .shadow { width: 90%; background: rgba(0,0,0,0.15); }

        /* Item Specifics */
        .item-tree .emoji { font-size: 8rem; }
        .item-santa .emoji { font-size: 5.5rem; }
        .item-deer .emoji { font-size: 4.5rem; }
        .item-snowman .emoji { font-size: 4.5rem; }
        .item-gift .emoji { font-size: 3rem; }
        .item-gift { margin: 0 -5px; z-index: 25; } /* Overlap gifts slightly */

        /* Animations & Effects */
        .anim-wiggle { animation: wiggle 0.6s ease-in-out; }
        @keyframes wiggle { 0%,100% { transform: rotate(0); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); } }

        .anim-jump { animation: jump 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes jump { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-40px); } }

        .anim-glow { animation: treeGlow 1s ease-in-out infinite alternate; }
        @keyframes treeGlow { from { filter: drop-shadow(0 0 5px gold); } to { filter: drop-shadow(0 0 25px gold) brightness(1.3); } }

        /* Pop-up Bubble */
        .pop-bubble {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 8px 16px; border-radius: 16px;
            font-size: 1rem; color: #FF8FA3; font-weight: bold;
            white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0; pointer-events: none; font-family: 'Fredoka One';
            z-index: 100;
        }
        .pop-bubble.show { animation: popShow 2s forwards; }
        @keyframes popShow { 
            0% { opacity: 0; transform: translate(-50%, 10px) scale(0.8); } 
            20% { opacity: 1; transform: translate(-50%, 0) scale(1); } 
            80% { opacity: 1; transform: translate(-50%, -15px); }
            100% { opacity: 0; transform: translate(-50%, -40px); } 
        }
        .pop-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid; border-color: #fff transparent transparent transparent;
        }

        /* Flying Sleigh */
        .sleigh-container {
            position: absolute; top: 12%; left: -300px;
            font-size: 2.5rem; opacity: 0.9; pointer-events: none; z-index: 5;
        }
        .sleigh-container.fly { animation: sleighRide 12s linear forwards; }
        @keyframes sleighRide {
            0% { transform: translateX(0) translateY(0) rotate(5deg); left: -300px; }
            25% { transform: translateX(25vw) translateY(20px) rotate(0deg); }
            50% { transform: translateX(50vw) translateY(0) rotate(-5deg); }
            75% { transform: translateX(75vw) translateY(20px) rotate(0deg); }
            100% { transform: translateX(100vw) translateY(0) rotate(5deg); left: 100vw; }
        }

        .snow-ground { position: fixed; bottom: -40px; left: 0; width: 100%; height: 120px; background: white; border-radius: 50% 50% 0 0 / 100% 100% 0 0; transform: scaleX(1.5); z-index: 2; transition: transform 1s ease; }  
        
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(105vh) rotate(360deg); opacity: 0; } }  
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; pointer-events: none; } 
        
        /* é—ªå…‰è½¬åœºä¼˜åŒ– */
        #flash-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 9999; pointer-events: none; 
            opacity: 0; transition: opacity 1.5s ease-in-out; 
        }

        /* =========================================
           THEME ANIMATIONS (Unique for each memory)
           ========================================= */
        /* Theme 1: Sakura (åˆè¯†) */
        .fx-sakura { position: absolute; font-size: 1.5rem; animation: sakuraFall linear infinite; opacity: 0.8; }
        @keyframes sakuraFall { 0% { transform: translateY(-10vh) rotate(0deg) translateX(0); } 100% { transform: translateY(110vh) rotate(360deg) translateX(20px); } }

        /* Theme 2: Paper Plane (åˆ†äº«) */
        .fx-plane { position: absolute; font-size: 2.5rem; animation: planeFly linear infinite; opacity: 0.9; }
        @keyframes planeFly { 
            0% { transform: translate(-20vw, 10vh) rotate(10deg) scale(0.5); opacity: 0; } 
            20% { opacity: 1; }
            100% { transform: translate(120vw, -30vh) rotate(-10deg) scale(1); opacity: 1; } 
        }

        /* Theme 3: Gaming (æ¸¸æˆ) */
        .fx-game-icon { position: absolute; font-size: 3rem; animation: gamePop infinite alternate; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
        .fx-game-vs { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15rem; font-weight: 900; color: rgba(255,255,255,0.05); font-family: 'Fredoka One'; animation: pulseVs 2s infinite; }
        @keyframes gamePop { 0% { transform: scale(1) rotate(-5deg); } 100% { transform: scale(1.1) rotate(5deg); } }
        @keyframes pulseVs { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } }

        /* Theme 4: Warmth (æ”¯æ’‘) */
        .fx-warm-glow { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80vw; height: 80vw; background: radial-gradient(circle, rgba(255, 165, 0, 0.3) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%; animation: warmPulse 4s infinite ease-in-out;
        }
        @keyframes warmPulse { 0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); } }

        /* Theme 5: Laughter (æ¬¢ç¬‘) */
        .fx-laugh { position: absolute; font-size: 2.5rem; animation: floatBubble linear infinite; }
        @keyframes floatBubble { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }

        /* Theme 6: Winter (è¿‡å†¬) */
        .fx-frost { position: absolute; inset: 0; box-shadow: inset 0 0 100px rgba(200, 230, 255, 0.8); pointer-events: none; z-index: 10; }

        /* Theme 7: Stars (è®¸æ„¿) */
        .fx-star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
        .fx-shooting-star { 
            position: absolute; width: 100px; height: 2px; background: linear-gradient(90deg, white, transparent);
            transform: rotate(-45deg); animation: shootStar 3s linear infinite; opacity: 0;
        }
        @keyframes twinkle { 0% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }
        @keyframes shootStar { 0% { transform: translate(0, 0) rotate(-45deg); opacity: 1; } 20% { opacity: 1; } 100% { transform: translate(-50vw, 50vh) rotate(-45deg); opacity: 0; } }

        /* Theme 8: Balloons (é™ªä¼´) */
        .fx-balloon { position: absolute; font-size: 3rem; animation: balloonRise linear infinite; }
        @keyframes balloonRise { 0% { transform: translateY(110vh) translateX(0); } 50% { transform: translateY(50vh) translateX(20px); } 100% { transform: translateY(-20vh) translateX(-20px); } }

        /* Theme 9: Golden (ç¥ç¦) */
        .fx-gold { position: absolute; width: 6px; height: 6px; background: #FFD700; border-radius: 50%; animation: goldRain linear infinite; box-shadow: 0 0 5px #FFD700; }
        @keyframes goldRain { 0% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }

    </style>  
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>  
<body>  
    
    <!-- èµ„æºåŠ è½½é¡µ (Optimized) -->
    <div id="loading-screen">
        <div class="loading-icon">ğŸ</div>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-text">æ­£åœ¨æ‰“åŒ…ç¾å¥½çš„å›å¿†...</div>
    </div>

    <!-- é¡¶éƒ¨å½©ç¯è£…é¥° -->
    <div class="light-rope">
        <div class="light-wire"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
        <div class="light-bulb"></div>
    </div>

    <!-- 0. åŸºç¡€æ¸å˜èƒŒæ™¯ -->
    <div id="bg-base-layer"></div>

    <!-- 1. ä¸»é¢˜ç‰¹æ•ˆå±‚ (å›å¿†æ—¶åŠ¨æ€å˜åŒ–) -->
    <div id="theme-layer"></div>

    <!-- 2. å…¨å±€é›ªèŠ±å±‚ -->
    <div id="snow-container"></div>  

    <!-- é—ªå…‰è½¬åœºå±‚ -->
    <div id="flash-overlay"></div>

    <!-- èƒŒæ™¯éŸ³ä¹ (é¢„åŠ è½½) -->
    <audio id="bgm" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/holiday/jingle_bells.ogg" type="audio/ogg">
    </audio>
    <div id="music-control" onclick="toggleMusic(event)">ğŸµ</div>
  
    <!-- åºç«  -->  
    <div id="stage-0-intro" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <div class="dialog-content" id="intro-text"></div>  
            <button class="action-btn disabled" id="btn-intro" onclick="startMemories()">å¼€å¯å›å¿† &gt;</button>  
        </div>  
    </div>  
  
    <!-- å›å¿†æ’­æ”¾å™¨ -->  
    <div id="stage-1-memory" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 id="mem-title" style="color: #D4A373; font-size: 1.4rem; font-family: 'Fredoka One';"></h3>  
            <div class="dialog-content typing-cursor" id="mem-text"></div>  
            <button class="action-btn disabled" id="btn-mem" onclick="nextMemory()">ä¸‹ä¸€æ­¥ &gt;</button>  
        </div>
    </div>  
  
    <!-- æ¸¸æˆå¼•å¯¼ -->  
    <div id="stage-2-invite" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <div class="dialog-content" id="invite-text"></div>  
            <!-- å…¨è‡ªåŠ¨æ¨¡å¼ï¼Œéšè—æŒ‰é’® -->
            <button class="action-btn disabled" id="btn-invite" style="display:none;">  
                æ¥æ”¶ç¥ç¦ âœ¨  
            </button>  
        </div>  
    </div>  
  
    <!-- çˆ±å¿ƒåŠ¨ç”»å±‚ -->  
    <div id="game-layer"></div>  
  
    <!-- ç¤¼ç‰©å¡ç‰‡ -->  
    <div id="stage-3-card" class="overlay-stage">  
        <div class="welcome-card">  
            <div class="ribbon"></div>  
            <h2 class="card-title">To: äº²çˆ±çš„ä½  âœ¨</h2>  
            <p class="card-text" style="font-size: 1.2rem;">  
                é›†é½å•¦ï¼<br>æ¯ä¸€ä¸ªæ–¹å—éƒ½æ˜¯æˆ‘çš„å¿ƒæ„ã€‚<br>åœ£è¯å¿«ä¹ï¼  
            </p>  
            <div class="memory-lane">  
                <div class="polaroid"><div class="polaroid-img">ğŸ¬</div></div>  
                <div class="polaroid"><div class="polaroid-img">ğŸŒŸ</div></div>  
            </div>  
            <button class="action-btn" style="float:none;" onclick="revealFinal()">æ‹†å¼€ç¤¼ç‰© ğŸ</button>  
        </div>  
    </div>  
  
    <!-- æœ€ç»ˆåœºæ™¯ (Updated: Interactive & Richer) -->  
    <div id="main-scene">  
        <div class="scene-header">
            <h1 class="final-title">Merry Christmas!</h1>  
            <div class="final-subtitle">å±äºä½ çš„å¯çˆ±å†¬å¤© âœ¨</div>
        </div>
        
        <!-- Background Elements -->
        <div class="moon-wrapper" onclick="interact('moon', this)">
            <div class="moon">ğŸŒ•</div>
        </div>

        <div class="forest-layer">
            <div class="tree-bg">ğŸŒ²</div>
            <div class="tree-bg">ğŸŒ²</div>
            <div class="tree-bg">ğŸŒ²</div>
            <div class="tree-bg">ğŸŒ²</div>
        </div>

        <div class="cabin-wrapper" onclick="interact('cabin', this)">
            <div class="pop-bubble">æ¬¢è¿å›å®¶~</div>
            <div class="cabin">ğŸ¡</div>
            <div class="smoke-container">
                <div class="smoke"></div>
                <div class="smoke"></div>
            </div>
        </div>

        <!-- Flying Elements -->
        <div class="sleigh-container" id="sleigh">ğŸ…ğŸ¦ŒğŸ’¨</div>

        <!-- Interactive Characters -->
        <div class="scene-stage">
            <div class="interact-item item-snowman" onclick="interact('snowman', this)">
                <div class="pop-bubble">å¥½å‡‰å¿«å‘€~</div>
                <div class="emoji">â›„</div>
                <div class="shadow"></div>
            </div>

            <div class="interact-item item-gift" onclick="interact('gift', this)">
                <div class="pop-bubble">å¥½è¿+1</div>
                <div class="emoji">ğŸ</div>
                <div class="shadow" style="width:50%"></div>
            </div>

            <div class="interact-item item-tree" onclick="interact('tree', this)">
                <div class="pop-bubble">Bling Bling!</div>
                <div class="emoji">ğŸ„</div>
                <div class="shadow"></div>
            </div>

            <div class="interact-item item-gift" onclick="interact('gift', this)">
                <div class="pop-bubble">æš´å¯Œ+1</div>
                <div class="emoji">ğŸ</div>
                <div class="shadow" style="width:50%"></div>
            </div>

            <div class="interact-item item-santa" onclick="interact('santa', this)">
                <div class="pop-bubble">Ho Ho Ho~</div>
                <div class="emoji">ğŸ…</div>
                <div class="shadow"></div>
            </div>

            <div class="interact-item item-deer" onclick="interact('deer', this)">
                <div class="pop-bubble">åœ£è¯å¿«ä¹!</div>
                <div class="emoji">ğŸ¦Œ</div>
                <div class="shadow"></div>
            </div>
        </div>
    </div>  
    <div class="snow-ground"></div>  
  
    <script>  
        // ================= æ•°æ®é…ç½® =================  
        
        const INTRO_TEXT = "è¿™æ˜¯æˆ‘ä»¬è®¤è¯†åæˆ‘é™ªä½ åº¦è¿‡çš„ç¬¬ä¸€ä¸ªåœ£è¯èŠ‚\nè°¨ä»¥æ­¤çºªå¿µæˆ‘ä»¬çš„å‹è°Š\nåœ¨è¿™ä¸ªå¯’å†·çš„å†¬å¤©ï¼Œå¸Œæœ›å¯ä»¥ä¸ºä½ å¸¦æ¥ä¸€ä¸æ¸©æš–";
        const INVITE_TEXT = "Helloï¼Œåœ£è¯å¿«ä¹ï¼\nè¿™é‡Œæœ‰ä¸€ä»½ç‰¹åˆ«çš„ç¤¼ç‰©é€ç»™ä½ ã€‚\nå‡†å¤‡å¥½äº†å—ï¼Ÿ";

        const MESSAGES = [  
            "ğŸå¹³å®‰", "ğŸ’°æš´å¯Œ", "ğŸ€å¥½è¿", "â¤ï¸Love",   
            "âœ¨é—ªè€€", "ğŸ„Xmas", "ğŸç¤¼ç‰©", "ğŸ’ªåŠ æ²¹",   
            "ğŸ¬ç”œèœœ", "ğŸ±å¯çˆ±", "ğŸŒˆç¾å¥½", "ğŸš€ä¸Šå²¸",   
            "ğŸ‰æ¬¢åº†", "â„ï¸çº¯æ´", "ğŸŒŸå¸Œæœ›", "ğŸ–ï¸è‡ªç”±",   
            "ğŸ˜„å¼€å¿ƒ", "ğŸŸé”¦é²¤", "ğŸ æ¸©é¦¨", "ğŸ‘­å‹è°Š",  
            "ğŸ°å¹¸ç¦", "ğŸŒ™æ™šå®‰", "ğŸ§¸é™ªä¼´", "ğŸ¶å¿«ä¹"  
        ];  

        const MEMORIES = [
            { t: "(1/9) ğŸŒ±", c: "è¿˜è®°å¾—æˆ‘ä»¬åˆšè®¤è¯†çš„æ—¶å€™å—ï¼Ÿ\né‚£æ—¶è™½ç„¶æœ‰äº›æ‹˜è°¨ï¼Œ\nä½†æ¯ä¸€æ¬¡å¯¹è¯éƒ½è®©æˆ‘è§‰å¾—ç‰¹åˆ«æŠ•ç¼˜ã€‚\nåƒæ˜¯æ˜¥é£å¹è¿›äº†å¿ƒé‡Œã€‚", theme: 'sakura' },
            { t: "(2/9) ğŸ“±", c: "åæ¥æˆ‘ä»¬è¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œ\nå¼€å§‹åˆ†äº«å½¼æ­¤çš„å–œæ€’å“€ä¹ï¼Œ\nå“ªæ€•æ˜¯ç”Ÿæ´»é‡Œçš„èŠéº»å°äº‹ï¼Œ\nä¹Ÿæ€»æƒ³ç¬¬ä¸€æ—¶é—´å‘Šè¯‰ä½ ã€‚", theme: 'planes' },
            { t: "(3/9) ğŸ®", c: "æœ€å¼€å¿ƒçš„å°±æ˜¯å’Œä½ ä¸€èµ·æ‰“æ¸¸æˆï¼\nä¸ç®¡æ˜¯ç‹è€…è£è€€è¿˜æ˜¯å’Œå¹³ç²¾è‹±...\næ¯ä¸€æ¬¡ç»„é˜Ÿå¼€é»‘ï¼Œ\néƒ½æ˜¯æˆ‘ä»¬ä¸“å±çš„å¿«ä¹æ—¶å…‰ï¼", theme: 'gaming' },
            { t: "(4/9) ğŸ’ª", c: "å½“ç„¶ä¹Ÿæœ‰ä¸€èµ·emoçš„æ—¶å€™ï¼Œ\näº’ç›¸åæ§½ç”Ÿæ´»çš„ä¸æ˜“ã€å·¥ä½œçš„çƒ¦æ¼ã€‚\nä½†åªè¦äº’ç›¸æ‰“æ‰“æ°”ï¼Œ\nå¥½åƒå°±åˆæœ‰äº†ç»§ç»­å‡çº§æ‰“æ€ªçš„åŠ¨åŠ›ã€‚", theme: 'warmth' },
            { t: "(5/9) ğŸ˜‚", c: "è°¢è°¢ä½ æ€»æ˜¯èƒ½æ¥ä½æˆ‘çš„å¥‡å¥‡æ€ªæ€ªï¼Œ\né‚£äº›åªæœ‰æˆ‘ä»¬æ‡‚çš„æ¢—ï¼Œ\næ¯æ¬¡æƒ³èµ·æ¥éƒ½ä¼šå¿ä¸ä½å˜´è§’ä¸Šæ‰¬ã€‚\nå’Œä½ èŠå¤©çœŸçš„è¶…çº§è½»æ¾å¿«ä¹ã€‚", theme: 'laugh' },
            { t: "(6/9) â„ï¸", c: "ä¸çŸ¥ä¸è§‰ï¼Œ\nåˆä¸€èµ·èµ°è¿‡äº†ä¸€ä¸ªæ˜¥å¤ç§‹å†¬ï¼Œ\nè¿æ¥äº†è¿™ä¸ªæµªæ¼«çš„åœ£è¯èŠ‚ã€‚\nå› ä¸ºæœ‰ä½ ï¼Œè¿™ä¸ªå†¬å¤©å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆå†·äº†ã€‚", theme: 'winter' },
            { t: "(7/9) âœ¨", c: "åœ£è¯èŠ‚åˆ°äº†ï¼Œ\næƒ³æŠŠæ˜Ÿæ˜Ÿæ‘˜ä¸‹æ¥é€ç»™ä½ ï¼Œ\næƒ³æŠŠä¸–ç•Œä¸Šæœ€ç¾å¥½çš„ç¥ç¦éƒ½ç»™ä½ ã€‚\nå¸Œæœ›ä½ æ¯å¤©éƒ½èƒ½é‡è§å±äºä½ çš„å°ç¡®å¹¸ã€‚", theme: 'stars' },
            { t: "(8/9) ğŸˆ", c: "è°¢è°¢ä½ å‡ºç°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œ\næˆä¸ºæˆ‘ç‰¹åˆ«çš„æœ‹å‹ã€‚\nå¸Œæœ›åœ¨æœªæ¥çš„æ—¥å­é‡Œï¼Œ\næˆ‘ä»¬å¯ä»¥ç»§ç»­ä¸€èµ·å¤§ç¬‘ï¼Œä¸€èµ·å¯å¯çˆ±çˆ±ã€‚", theme: 'balloons' },
            { t: "(9/9) ğŸ„", c: "æœ€åï¼Œ\näº²çˆ±çš„å°èƒ¡åŒå­¦ï¼Œ\næ„¿ä½ æ°¸è¿œè¢«çˆ±åŒ…å›´ï¼Œä¸‡äº‹èƒœæ„ï¼\nåœ£è¯å¿«ä¹ï¼Œä¸æ­¢åœ£è¯ï¼Œæ¯å¤©éƒ½å¿«ä¹ï¼", theme: 'gold' }
        ];
  
        // ================= ç³»ç»Ÿå˜é‡ =================  
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        let currentMemIndex = 0;

        // ================= åˆå§‹åŒ– =================  
        window.onload = async () => {
            await document.fonts.ready;
            
            // è§¦å‘è¿›åº¦æ¡åŠ¨ç”»
            const bar = document.getElementById('loading-bar');
            const screen = document.getElementById('loading-screen');
            
            // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
            setTimeout(() => bar.style.width = '60%', 200);
            setTimeout(() => bar.style.width = '100%', 1000);

            // è¿›åº¦æ¡æ»¡åå†æ¶ˆå¤±
            setTimeout(() => {
                screen.style.opacity = '0';
                setTimeout(() => screen.style.display = 'none', 800);
                
                // æ˜¾ç¤ºé¦–é¡µ
                showStage('stage-0-intro');
                spawnBgIcon();
                
                setTimeout(() => {
                    typeWriter(document.getElementById('intro-text'), INTRO_TEXT, () => {
                        enableBtn('btn-intro');
                    });
                }, 800);
            }, 1800);

            setInterval(createSnow, 200);
        };

        // ================= ç‰¹æ•ˆå¼•æ“ (Theme Engine) =================  
        function applyTheme(theme) {
            const layer = document.getElementById('theme-layer');
            const body = document.body;
            layer.innerHTML = ''; // æ¸…é™¤æ—§ç‰¹æ•ˆ
            
            // é»˜è®¤èƒŒæ™¯æ¢å¤
            if(theme === 'default') {
                body.style.backgroundColor = '#FFFBF0';
                document.getElementById('bg-base-layer').style.opacity = '1';
                return;
            }

            // é»˜è®¤è¿‡æ¸¡çŠ¶æ€
            document.getElementById('bg-base-layer').style.opacity = '1';
            body.style.backgroundColor = '#FFFBF0';

            switch(theme) {
                case 'sakura': // 1. æ¨±èŠ±
                    body.style.backgroundColor = '#fff0f5'; 
                    createParticles(layer, 'ğŸŒ¸', 20, 'fx-sakura', 5, 10);
                    break;
                case 'planes': // 2. çº¸é£æœº
                    body.style.backgroundColor = '#e6f7ff'; 
                    createParticles(layer, 'âœˆï¸', 6, 'fx-plane', 8, 15);
                    break;
                case 'gaming': // 3. æ¸¸æˆ
                    document.getElementById('bg-base-layer').style.opacity = '0.1'; 
                    body.style.backgroundColor = '#1a103c'; 
                    const vs = document.createElement('div');
                    vs.className = 'fx-game-vs'; vs.innerText = 'VS';
                    layer.appendChild(vs);
                    const icons = ['ğŸ®', 'âš¡', 'ğŸ”¥', 'ğŸ‘¾', 'âš”ï¸', 'ğŸ†'];
                    for(let i=0; i<15; i++) {
                        const p = document.createElement('div');
                        p.className = 'fx-game-icon';
                        p.innerText = icons[Math.floor(Math.random()*icons.length)];
                        p.style.left = Math.random()*90 + 5 + 'vw';
                        p.style.top = Math.random()*90 + 5 + 'vh';
                        p.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(p);
                    }
                    break;
                case 'warmth': // 4. æš–é˜³
                    document.getElementById('bg-base-layer').style.opacity = '0.2';
                    body.style.backgroundColor = '#2c3e50';
                    const glow = document.createElement('div');
                    glow.className = 'fx-warm-glow';
                    layer.appendChild(glow);
                    break;
                case 'laugh': // 5. æ¬¢ç¬‘
                    body.style.backgroundColor = '#fffde7'; 
                    createParticles(layer, ['ğŸ˜‚','ğŸ¤£','ğŸ˜¹','ğŸ˜†'][Math.floor(Math.random()*4)], 15, 'fx-laugh', 4, 8, true);
                    break;
                case 'winter': // 6. è¿‡å†¬
                    body.style.backgroundColor = '#f0f8ff'; 
                    const frost = document.createElement('div');
                    frost.className = 'fx-frost';
                    layer.appendChild(frost);
                    for(let i=0; i<20; i++) setTimeout(createSnow, i*50);
                    break;
                case 'stars': // 7. æ˜Ÿç©º
                    document.getElementById('bg-base-layer').style.opacity = '0';
                    body.style.backgroundColor = '#0f172a'; 
                    for(let i=0; i<50; i++) {
                        const s = document.createElement('div');
                        s.className = 'fx-star';
                        const sz = Math.random()*3 + 1 + 'px';
                        s.style.width = sz; s.style.height = sz;
                        s.style.left = Math.random()*100 + 'vw'; s.style.top = Math.random()*100 + 'vh';
                        s.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(s);
                    }
                    for(let i=0; i<3; i++) {
                        const ss = document.createElement('div');
                        ss.className = 'fx-shooting-star';
                        ss.style.top = Math.random()*30 + 'vh';
                        ss.style.right = Math.random()*30 + 'vw';
                        ss.style.animationDelay = i*2 + 's';
                        layer.appendChild(ss);
                    }
                    break;
                case 'balloons': // 8. æ°”çƒ
                    createParticles(layer, 'ğŸˆ', 12, 'fx-balloon', 6, 12, true);
                    break;
                case 'gold': // 9. é‡‘è‰²
                    document.getElementById('bg-base-layer').style.opacity = '0.5';
                    body.style.backgroundColor = '#fffbe6';
                    for(let i=0; i<40; i++) {
                        const g = document.createElement('div');
                        g.className = 'fx-gold';
                        g.style.left = Math.random()*100 + 'vw';
                        g.style.animationDuration = Math.random()*2 + 3 + 's';
                        g.style.animationDelay = Math.random()*2 + 's';
                        layer.appendChild(g);
                    }
                    break;
            }
        }

        function createParticles(container, charOrArr, count, className, minDur, maxDur, randomizeChar=false) {
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = className;
                if(randomizeChar && Array.isArray(charOrArr)) {
                    p.innerText = charOrArr[Math.floor(Math.random()*charOrArr.length)];
                } else if (randomizeChar) {
                     p.innerText = charOrArr; 
                     if(className === 'fx-laugh') p.innerText = ['ğŸ˜‚','ğŸ¤£','ğŸ˜¹','ğŸ˜†'][Math.floor(Math.random()*4)];
                     if(className === 'fx-balloon') p.style.filter = `hue-rotate(${Math.random()*360}deg)`;
                } else {
                    p.innerText = charOrArr;
                }
                
                p.style.left = Math.random() * 90 + 5 + 'vw';
                const dur = Math.random() * (maxDur - minDur) + minDur;
                p.style.animationDuration = dur + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        // ================= å¸¸è§„é€»è¾‘ =================  

        function spawnBgIcon() {
            const container = document.getElementById('bg-base-layer');
            const icons = ['ğŸ„', 'ğŸ…', 'ğŸ¦Œ', 'ğŸ', 'ğŸ””'];
            setInterval(() => {
                if(container.childElementCount > 10) return;
                const icon = document.createElement('div');
                icon.className = 'floating-icon'; 
                icon.style.cssText = `position:absolute; font-size:3rem; opacity:0.15; filter:blur(2px); user-select:none; animation: floatUp 20s linear infinite;`;
                icon.innerText = icons[Math.floor(Math.random()*icons.length)];
                icon.style.left = Math.random()*90 + 'vw';
                container.appendChild(icon);
                setTimeout(()=>icon.remove(), 20000);
            }, 2000);
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(20deg); } }`;
            document.head.appendChild(style);
        }

        // [æ ¸å¿ƒ] ä¼˜åŒ–çš„è½¬åœºé€»è¾‘
        function showStage(id) {
            // 1. æ‰¾åˆ°å½“å‰æ¿€æ´»çš„åœºæ™¯ï¼Œæ‰§è¡Œé€€å‡ºåŠ¨ç”»
            const current = document.querySelector('.overlay-stage.active');
            
            const enterNewStage = () => {
                const target = document.getElementById(id);
                if(target) {
                    target.style.display = 'flex';
                    // å¼ºåˆ¶é‡ç»˜ç¡®ä¿transitionç”Ÿæ•ˆ
                    target.offsetHeight; 
                    target.classList.add('active');
                }
            };

            if (current) {
                current.classList.add('exit'); // è§¦å‘é€€å‡ºCSSåŠ¨ç”»
                current.classList.remove('active');
                
                // ç­‰å¾…CSSè¿‡æ¸¡ç»“æŸ (0.5s)
                setTimeout(() => {
                    current.style.display = 'none';
                    current.classList.remove('exit');
                    enterNewStage();
                }, 550);
            } else {
                enterNewStage();
            }
        }

        function typeWriter(element, text, onComplete) {
            element.innerHTML = ""; element.classList.add('typing-cursor');
            let i = 0;
            const t = setInterval(() => {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.innerHTML += (char === '\n' ? '<br>' : char);
                    i++;
                    element.parentElement.scrollTop = element.parentElement.scrollHeight;
                } else {
                    clearInterval(t);
                    element.classList.remove('typing-cursor');
                    if (onComplete) onComplete();
                }
            }, 50);
        }

        function enableBtn(id) { document.getElementById(id).classList.remove('disabled'); }

        function toggleMusic(e) {
            e.stopPropagation();
            if (bgm.paused) {
                bgm.play(); musicBtn.classList.add('playing'); musicBtn.innerText = 'ğŸµ';
            } else {
                bgm.pause(); musicBtn.classList.remove('playing'); musicBtn.innerText = 'ğŸš«';
            }
        }

        function startMemories() {
            if(bgm.paused) toggleMusic({stopPropagation:()=>{}});
            showStage('stage-1-memory');
            renderMemory(0);
        }

        function renderMemory(index) {
            currentMemIndex = index;
            const data = MEMORIES[index];
            const titleEl = document.getElementById('mem-title');
            const textEl = document.getElementById('mem-text');
            const btn = document.getElementById('btn-mem');

            applyTheme(data.theme);

            // å†…å®¹åˆ‡æ¢å°åŠ¨ç”»
            textEl.style.opacity = '0';
            setTimeout(() => {
                textEl.style.opacity = '1';
                titleEl.innerText = data.t;
                btn.classList.add('disabled'); 
                typeWriter(textEl, data.c, () => {
                    enableBtn('btn-mem');
                });
            }, 200);
        }

        function nextMemory() {
            if (currentMemIndex < MEMORIES.length - 1) {
                renderMemory(currentMemIndex + 1);
            } else {
                applyTheme('default'); // æ¢å¤é»˜è®¤èƒŒæ™¯
                showStage('stage-2-invite');
                setTimeout(() => {
                    typeWriter(document.getElementById('invite-text'), INVITE_TEXT, () => {
                        // è‡ªåŠ¨æµç¨‹ï¼š1.5ç§’åè‡ªåŠ¨å¼€å§‹æ¸¸æˆ
                        setTimeout(startHeartAnimation, 1500);
                    });
                }, 600);
            }
        }

        function startHeartAnimation() {
            // è¿™é‡Œçš„é€»è¾‘ç¨æœ‰ä¸åŒï¼šInvite é€€å‡ºï¼ŒGameLayer æµ®ç°
            const inviteStage = document.getElementById('stage-2-invite');
            // æ‰‹åŠ¨è§¦å‘Inviteçš„é€€å‡ºåŠ¨ç”»
            inviteStage.classList.add('exit');
            inviteStage.classList.remove('active');
            setTimeout(() => { inviteStage.style.display = 'none'; inviteStage.classList.remove('exit'); }, 600);

            const layer = document.getElementById('game-layer');
            layer.style.display = 'block'; 

            const w = window.innerWidth; const h = window.innerHeight;
            const cx = w / 2; const cy = h / 2;
            const scale = Math.min(w, h) < 400 ? 11 : 14; 
            const delay = 200; 

            MESSAGES.forEach((msg, i) => {
                const t = (i / MESSAGES.length) * 2 * Math.PI;
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                const targetX = (x * scale + cx) - 30;
                const targetY = (y * scale + cy) - 30;

                const box = document.createElement('div');
                box.className = 'msg-box';
                box.innerText = msg;
                box.style.left = (cx - 30) + 'px'; box.style.top = (cy - 30) + 'px';
                layer.appendChild(box);
                
                // çˆ†ç‚¸ç‰¹æ•ˆç²’å­
                createExplosion(cx, cy);

                setTimeout(() => {
                    box.style.left = targetX + 'px';
                    box.style.top = targetY + 'px';
                    box.style.opacity = '1';
                    box.style.transform = 'scale(1)';
                    // éšæœºå¼€å§‹å‘¼å¸åŠ¨ç”»ï¼Œé¿å…æ•´é½åˆ’ä¸€
                    setTimeout(() => box.classList.add('floating'), 1000 + Math.random() * 1000);
                }, i * delay); 
            });

            const totalTime = (MESSAGES.length) * delay + 2000;
            setTimeout(finishGame, totalTime);
        }

        function createExplosion(x, y) {
            // ç®€å•çš„ç²’å­ç”Ÿæˆ
            for(let k=0; k<4; k++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.background = ['#FF8FA3','#B5EAD7','#FFE577'][Math.floor(Math.random()*3)];
                p.style.left = x + 'px'; p.style.top = y + 'px';
                
                // éšæœºæ–¹å‘
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 50 + 20;
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                
                p.style.animation = `explode 0.6s ease-out forwards`;
                document.getElementById('game-layer').appendChild(p);
                setTimeout(()=>p.remove(), 600);
            }
        }

        function finishGame() {
            // éšè—æ¸¸æˆå±‚
            const layer = document.getElementById('game-layer');
            // ç®€å•æ¸éš
            layer.style.transition = 'opacity 0.8s';
            layer.style.opacity = '0';
            setTimeout(() => { layer.style.display = 'none'; }, 800);
            
            showStage('stage-3-card');
        }

        // Interaction handler for final scene
        function interact(type, el) {
            const bubble = el.querySelector('.pop-bubble');
            const emoji = el.querySelector('.emoji');
            
            // Remove anim classes to allow restart
            el.classList.remove('anim-wiggle', 'anim-jump');
            if(emoji) emoji.classList.remove('anim-glow');
            
            // Trigger Reflow
            void el.offsetWidth;

            // Show bubble
            if (bubble) {
                bubble.classList.remove('show');
                void bubble.offsetWidth;
                bubble.classList.add('show');
            }

            switch(type) {
                case 'snowman':
                case 'santa':
                    el.classList.add('anim-wiggle');
                    break;
                case 'deer':
                case 'gift':
                case 'cabin':
                    el.classList.add('anim-jump');
                    break;
                case 'tree':
                case 'moon':
                    if(emoji || el.querySelector('.moon')) (emoji || el.querySelector('.moon')).classList.add('anim-glow');
                    break;
            }
        }

        function startSleighLoop() {
            const s = document.getElementById('sleigh');
            if(!s) return;
            
            const runAnimation = () => {
                s.classList.remove('fly');
                void s.offsetWidth;
                s.classList.add('fly');
                // Schedule next run (animation takes 12s, wait 3s more)
                setTimeout(runAnimation, 15000);
            };
            runAnimation();
        }

        function revealFinal() {
            const cardStage = document.getElementById('stage-3-card');
            // è§¦å‘é€€å‡ºåŠ¨ç”»
            cardStage.classList.add('exit');
            cardStage.classList.remove('active');
            
            // å¼€å¯ç™½å±é—ªå…‰
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = '1';
            
            // éšè—é¡¶éƒ¨çš„ç¯ï¼ˆä¸ºäº†ç»“å±€å¹²å‡€ï¼‰
            document.querySelector('.light-rope').classList.add('hidden');

            setTimeout(() => {
                cardStage.style.display = 'none';
                const mainScene = document.getElementById('main-scene');
                mainScene.classList.add('active');
                
                applyTheme('gold'); 
                
                // æ…¢æ…¢æ·¡å‡ºç™½å±ï¼Œæ˜¾éœ²ç»“å±€
                setTimeout(() => { 
                    flash.style.opacity = '0'; 
                    // Start flying sleigh animation
                    startSleighLoop();
                }, 500);
            }, 1200); 
        }

        function createSnow() {
            const c = document.getElementById('snow-container');
            if (c.childElementCount > 40) return; 
            const s = document.createElement('div');
            s.classList.add('snowflake');
            const size = Math.random() * 8 + 5 + 'px';
            s.style.width = size; s.style.height = size;
            s.style.left = Math.random() * 100 + 'vw';
            s.style.opacity = Math.random() * 0.5 + 0.3;
            const d = Math.random() * 5 + 5 + 's';
            s.style.animation = `fall ${d} linear infinite`;
            c.appendChild(s);
            setTimeout(() => s.remove(), parseFloat(d) * 1000);
        }
    </script>  
</body>  
</html>
