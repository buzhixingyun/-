<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <!-- ç¦ç”¨ç¼©æ”¾ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒï¼Œè§£å†³ iOS ç‚¹å‡»å»¶è¿Ÿ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Merry Christmas! ğŸ„</title>  
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">  
  
    <style>  
        /* --- 1. æ ¸å¿ƒé…è‰²ä¸åŸºç¡€è®¾ç½® --- */  
        :root {  
            --bg-color: #FFFBF0;        
            --primary: #FF8FA3;         
            --secondary: #B5EAD7;       
            --text-color: #D4A373;      
            --accent: #FFE577;          
            --card-bg: #FFFFFF;  
            --paper-color: #FFF8E7;  
        }  
  
        * { margin: 0; padding: 0; box-sizing: border-box; }  
  
        body {  
            background-color: var(--bg-color);  
            color: var(--text-color);  
            font-family: 'Nunito', 'Ma Shan Zheng', sans-serif;   
            overflow: hidden;   
            /* ä½¿ç”¨ dvh é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€åœ°å€æ  */
            height: 100vh; height: 100dvh; width: 100vw;  
            cursor: default;   
            /* ä¼˜åŒ–ç§»åŠ¨ç«¯äº¤äº’ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }  
  
        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 15px; font-family: 'Fredoka One'; color: var(--primary);
        }

        /* --- Background & Effects --- */
        #snow-container {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
            pointer-events: none; z-index: 1;  
        }  

        /* --- Music Button --- */
        #music-control {
            position: fixed; top: 20px; right: 20px;
            width: 44px; height: 44px; /* åŠ å¤§è§¦æ§åŒº */
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 22px;
            transition: transform 0.2s;
            user-select: none;
        }
        #music-control:active { transform: scale(0.9); }
        #music-control.playing { animation: spin 4s linear infinite; color: var(--primary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
  
        /* --- Stage System --- */  
        .overlay-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            /* å¢åŠ  backdrop-filter è¿‡æ¸¡ï¼Œä½¿èƒŒæ™¯æ¨¡ç³Šæ•ˆæœæ›´ä¸æ»‘ */
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s, backdrop-filter 0.8s;
            opacity: 0; visibility: hidden;
            backdrop-filter: blur(0px);
            -webkit-backdrop-filter: blur(0px);
        }

        /* åˆå§‹çŠ¶æ€ */
        #stage-0-intro { z-index: 500; }
        #stage-1-memory { z-index: 450; }
        #stage-2-invite { z-index: 400; }
        #stage-3-card { z-index: 350; }

        .overlay-stage.active { 
            opacity: 1; visibility: visible; 
            backdrop-filter: blur(5px); /* æ¿€æ´»æ—¶èƒŒæ™¯å¾®ç³Š */
            -webkit-backdrop-filter: blur(5px);
        }
        .overlay-stage.fade-out { opacity: 0; visibility: hidden; pointer-events: none; }

        /* --- Dialog UI --- */
        .dialog-box {  
            background-color: var(--paper-color);  
            width: 88%; max-width: 480px; padding: 35px 30px; 
            border-radius: 24px;  
            border: 3px solid var(--text-color);  
            box-shadow: 8px 8px 0px rgba(212, 163, 115, 0.4);  
            position: relative; 
            max-height: 85vh; overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            /* ä¼˜åŒ–å¼¹çª—åŠ¨ç”»ï¼šå¸¦æœ‰å¼¹æ€§çš„è¿›å…¥æ•ˆæœï¼Œé€€å‡ºæ—¶ç•¥å¾®ç¼©å° */
            transform: scale(0.9) translateY(20px); opacity: 0;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.6s ease;
        }
        .overlay-stage.active .dialog-box { transform: scale(1) translateY(0); opacity: 1; }
  
        .dialog-pin {  
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);  
            width: 16px; height: 16px; background: var(--primary); border-radius: 50%;  
            box-shadow: inset 2px 2px 4px rgba(255,255,255,0.6);  
        }  
  
        .dialog-content {  
            margin-top: 20px; font-family: 'Ma Shan Zheng', cursive; font-size: 1.3rem;  
            line-height: 1.8; color: #5d4037; text-align: left; min-height: 100px;
        }
        /* æ‰“å­—æœºå…‰æ ‡ */
        .typing-cursor::after {
            content: '|'; animation: blink 1s infinite; color: var(--primary);
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- Buttons --- */
        .action-btn {  
            background-color: var(--primary); color: white;  
            font-family: 'Fredoka One'; font-size: 1.1rem; letter-spacing: 1px;
            padding: 12px 32px; border: none; border-radius: 50px;  
            margin-top: 25px; cursor: pointer; float: right;  
            box-shadow: 0 4px 0 #d86c7f;  
            transition: transform 0.1s, box-shadow 0.1s;
            -webkit-tap-highlight-color: transparent; user-select: none;
        }  
        .action-btn:active { transform: translateY(4px); box-shadow: none; }  
        .action-btn.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }

        /* --- Heart Animation --- */  
        #game-layer {  
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 200; pointer-events: none;   
        }  
  
        .msg-box {  
            position: absolute; 
            width: 60px; height: 60px; 
            background: white; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center;  
            text-align: center; padding: 2px; 
            font-size: 15px; font-weight: bold;  
            color: #8d6e63; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);  
            font-family: 'Ma Shan Zheng', cursive; white-space: nowrap; overflow: hidden; 
            /* ä¸æ»‘ç§»åŠ¨çš„å…³é”®: cubic-bezier æ¨¡æ‹Ÿç‰©ç†å‡é€Ÿ */
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 0; 
            transform: scale(0);
        }  
  
        .msg-box:nth-child(4n+1) { background: #FFD1DC; color: #fff; }  
        .msg-box:nth-child(4n+2) { background: #E2F0CB; color: #779966; }  
        .msg-box:nth-child(4n+3) { background: #FFF5BA; color: #D4A373; }  
        .msg-box:nth-child(4n+4) { background: #FFFFFF; color: #FF8FA3; border: 2px solid #FF8FA3; }  

        /* --- Gift Card --- */  
        .welcome-card {  
            background: var(--card-bg); width: 90%; max-width: 450px; padding: 40px 30px;  
            border-radius: 30px; border: 4px dashed var(--primary);  
            box-shadow: 0 20px 50px rgba(212, 163, 115, 0.2); text-align: center;  
            transform: translateY(40px); opacity: 0; transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);   
        }  
        .overlay-stage.active .welcome-card { transform: translateY(0); opacity: 1; }  
  
        .ribbon { position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: var(--secondary); border-radius: 50%; opacity: 0.5; z-index: -1; }  
        .memory-lane { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; height: 110px; margin-top: 20px;}  
        .polaroid { background: white; padding: 6px 6px 20px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: rotate(-5deg); width: 90px; border: 1px solid #f0f0f0; }  
        .polaroid:nth-child(2) { transform: rotate(5deg) translateY(8px); }  
        .polaroid-img { width: 100%; height: 65px; background-color: #FFD1DC; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }  
  
        /* --- Final Scene --- */  
        #main-scene {  
            position: relative; z-index: 10; display: flex; flex-direction: column;  
            align-items: center; justify-content: center; height: 100%; text-align: center;  
            transition: filter 1s ease, opacity 1s; filter: blur(10px); opacity: 0; pointer-events: none;
        }  
        #main-scene.active { filter: blur(0); opacity: 1; pointer-events: auto; }  
        .snow-ground { position: fixed; bottom: -40px; left: 0; width: 100%; height: 120px; background: white; border-radius: 50% 50% 0 0 / 100% 100% 0 0; transform: scaleX(1.5); z-index: 2; }  
          
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(105vh) rotate(360deg); opacity: 0; } }  
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; pointer-events: none; }  

        /* --- Flash Effect --- */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; pointer-events: none;
            opacity: 0; transition: opacity 1s ease;
        }
    </style>  
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>  
<body>  
    
    <!-- èµ„æºåŠ è½½é¡µ -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading Memories...</div>
    </div>

    <!-- é—ªå…‰è½¬åœºå±‚ -->
    <div id="flash-overlay"></div>

    <!-- èƒŒæ™¯éŸ³ä¹ (é¢„åŠ è½½) -->
    <audio id="bgm" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/holiday/jingle_bells.ogg" type="audio/ogg">
    </audio>
    <div id="music-control" onclick="toggleMusic(event)">ğŸµ</div>
  
    <!-- é›ªèŠ±å±‚ -->
    <div id="snow-container"></div>  
  
    <!-- 1. åºç«  -->  
    <div id="stage-0-intro" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <!-- å†…å®¹ç•™ç©ºï¼Œç”±æ‰“å­—æœºå¡«å…… -->
            <div class="dialog-content" id="intro-text"></div>  
            <button class="action-btn disabled" id="btn-intro" onclick="startMemories()">å¼€å¯å›å¿† &gt;</button>  
        </div>  
    </div>  
  
    <!-- 2. å›å¿†æ’­æ”¾å™¨ -->  
    <div id="stage-1-memory" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 id="mem-title" style="color: #D4A373; font-size: 1.4rem; font-family: 'Fredoka One';"></h3>  
            <div class="dialog-content typing-cursor" id="mem-text"></div>  
            <button class="action-btn disabled" id="btn-mem" onclick="nextMemory()">ä¸‹ä¸€æ­¥ &gt;</button>  
        </div>
    </div>  
  
    <!-- 3. æ¸¸æˆå¼•å¯¼ -->  
    <div id="stage-2-invite" class="overlay-stage">  
        <div class="dialog-box">  
            <div class="dialog-pin"></div>  
            <h3 style="color: #D4A373; font-size: 1.5rem; font-family: 'Fredoka One'; margin-bottom: 10px;">  
                To: æœ€å¯çˆ±çš„å°èƒ¡åŒå­¦ ğŸ“  
            </h3>  
            <div class="dialog-content" id="invite-text"></div>  
            <button class="action-btn disabled" id="btn-invite" onclick="startHeartAnimation()">  
                æ¥æ”¶ç¥ç¦ âœ¨  
            </button>  
        </div>  
    </div>  
  
    <!-- 4. åŠ¨ç”»å±‚ -->  
    <div id="game-layer"></div>  
  
    <!-- 5. ç¤¼ç‰©å¡ç‰‡ -->  
    <div id="stage-3-card" class="overlay-stage">  
        <div class="welcome-card">  
            <div class="ribbon"></div>  
            <h2 class="card-title">To: äº²çˆ±çš„ä½  âœ¨</h2>  
            <p class="card-text" style="font-size: 1.2rem;">  
                é›†é½å•¦ï¼<br>æ¯ä¸€ä¸ªæ–¹å—éƒ½æ˜¯æˆ‘çš„å¿ƒæ„ã€‚<br>åœ£è¯å¿«ä¹ï¼  
            </p>  
            <div class="memory-lane">  
                <div class="polaroid"><div class="polaroid-img">ğŸ¬</div></div>  
                <div class="polaroid"><div class="polaroid-img">ğŸŒŸ</div></div>  
            </div>  
            <button class="action-btn" style="float:none;" onclick="revealFinal()">æ‹†å¼€ç¤¼ç‰© ğŸ</button>  
        </div>  
    </div>  
  
    <!-- 6. æœ€ç»ˆåœºæ™¯ -->  
    <div id="main-scene">  
        <h1 style="font-family: 'Fredoka One'; font-size: 3.2rem; color: #FF8FA3; margin-bottom: 15px; text-shadow: 2px 2px 0px #fff;">Merry Christmas!</h1>  
        <div style="font-size: 5rem; cursor: pointer; animation: float 3s infinite ease-in-out;">ğŸ¦Œ</div>  
        <p style="margin-top: 20px; color: #D4A373; font-weight: bold; font-size: 1.2rem;">å±äºä½ çš„å¯çˆ±å†¬å¤©</p>  
    </div>  
    <div class="snow-ground"></div>  
  
    <script>  
        // ================= æ•°æ®é…ç½® =================  
        
        // åºç« æ–‡å­—
        const INTRO_TEXT = "è¿™æ˜¯æˆ‘ä»¬è®¤è¯†åæˆ‘é™ªä½ åº¦è¿‡çš„ç¬¬ä¸€ä¸ªåœ£è¯èŠ‚\nè°¨ä»¥æ­¤çºªå¿µæˆ‘ä»¬çš„å‹è°Š\nåœ¨è¿™ä¸ªå¯’å†·çš„å†¬å¤©ï¼Œå¸Œæœ›å¯ä»¥ä¸ºä½ å¸¦æ¥ä¸€ä¸æ¸©æš–";
        
        // å¼•å¯¼æ–‡å­—
        const INVITE_TEXT = "Helloï¼Œåœ£è¯å¿«ä¹ï¼\nè¿™é‡Œæœ‰ä¸€ä»½ç‰¹åˆ«çš„ç¤¼ç‰©é€ç»™ä½ ã€‚\nå‡†å¤‡å¥½äº†å—ï¼Ÿ";

        // ç¥ç¦è¯­ (24ä¸ª)
        const MESSAGES = [  
            "ğŸå¹³å®‰", "ğŸ’°æš´å¯Œ", "ğŸ€å¥½è¿", "â¤ï¸Love",   
            "âœ¨é—ªè€€", "ğŸ„Xmas", "ğŸç¤¼ç‰©", "ğŸ’ªåŠ æ²¹",   
            "ğŸ¬ç”œèœœ", "ğŸ±å¯çˆ±", "ğŸŒˆç¾å¥½", "ğŸš€ä¸Šå²¸",   
            "ğŸ‰æ¬¢åº†", "â„ï¸çº¯æ´", "ğŸŒŸå¸Œæœ›", "ğŸ–ï¸è‡ªç”±",   
            "ğŸ˜„å¼€å¿ƒ", "ğŸŸé”¦é²¤", "ğŸ æ¸©é¦¨", "ğŸ‘­å‹è°Š",  
            "ğŸ°å¹¸ç¦", "ğŸŒ™æ™šå®‰", "ğŸ§¸é™ªä¼´", "ğŸ¶å¿«ä¹"  
        ];  

        // å›å¿†åˆ—è¡¨
        const MEMORIES = [
            { t: "(1/9) ğŸŒ±", c: "è¿˜è®°å¾—æˆ‘ä»¬åˆšè®¤è¯†çš„æ—¶å€™å—ï¼Ÿ\né‚£æ—¶è™½ç„¶æœ‰äº›æ‹˜è°¨ï¼Œ\nä½†æ¯ä¸€æ¬¡å¯¹è¯éƒ½è®©æˆ‘è§‰å¾—ç‰¹åˆ«æŠ•ç¼˜ã€‚" },
            { t: "(2/9) ğŸ“±", c: "åæ¥æˆ‘ä»¬è¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œ\nå¼€å§‹åˆ†äº«å½¼æ­¤çš„å–œæ€’å“€ä¹ï¼Œ\nå“ªæ€•æ˜¯ç”Ÿæ´»é‡Œçš„èŠéº»å°äº‹ï¼Œ\nä¹Ÿæ€»æƒ³ç¬¬ä¸€æ—¶é—´å‘Šè¯‰ä½ ã€‚" },
            { t: "(3/9) ğŸ®", c: "æœ€å¼€å¿ƒçš„å°±æ˜¯å’Œä½ ä¸€èµ·æ‰“æ¸¸æˆï¼\nä¸ç®¡æ˜¯ç‹è€…è£è€€è¿˜æ˜¯å’Œå¹³ç²¾è‹±...\næ¯ä¸€æ¬¡ç»„é˜Ÿå¼€é»‘ï¼Œ\néƒ½æ˜¯æˆ‘ä»¬ä¸“å±çš„å¿«ä¹æ—¶å…‰ï¼" },
            { t: "(4/9) ğŸ’ª", c: "å½“ç„¶ä¹Ÿæœ‰ä¸€èµ·emoçš„æ—¶å€™ï¼Œ\näº’ç›¸åæ§½ç”Ÿæ´»çš„ä¸æ˜“ã€å·¥ä½œçš„çƒ¦æ¼ã€‚\nä½†åªè¦äº’ç›¸æ‰“æ‰“æ°”ï¼Œ\nå¥½åƒå°±åˆæœ‰äº†ç»§ç»­å‡çº§æ‰“æ€ªçš„åŠ¨åŠ›ã€‚" },
            { t: "(5/9) ğŸ˜‚", c: "è°¢è°¢ä½ æ€»æ˜¯èƒ½æ¥ä½æˆ‘çš„å¥‡å¥‡æ€ªæ€ªï¼Œ\né‚£äº›åªæœ‰æˆ‘ä»¬æ‡‚çš„æ¢—ï¼Œ\næ¯æ¬¡æƒ³èµ·æ¥éƒ½ä¼šå¿ä¸ä½å˜´è§’ä¸Šæ‰¬ã€‚\nå’Œä½ èŠå¤©çœŸçš„è¶…çº§è½»æ¾å¿«ä¹ã€‚" },
            { t: "(6/9) â„ï¸", c: "ä¸çŸ¥ä¸è§‰ï¼Œ\nåˆä¸€èµ·èµ°è¿‡äº†ä¸€ä¸ªæ˜¥å¤ç§‹å†¬ï¼Œ\nè¿æ¥äº†è¿™ä¸ªæµªæ¼«çš„åœ£è¯èŠ‚ã€‚\nå› ä¸ºæœ‰ä½ ï¼Œè¿™ä¸ªå†¬å¤©å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆå†·äº†ã€‚" },
            { t: "(7/9) âœ¨", c: "åœ£è¯èŠ‚åˆ°äº†ï¼Œ\næƒ³æŠŠæ˜Ÿæ˜Ÿæ‘˜ä¸‹æ¥é€ç»™ä½ ï¼Œ\næƒ³æŠŠä¸–ç•Œä¸Šæœ€ç¾å¥½çš„ç¥ç¦éƒ½ç»™ä½ ã€‚\nå¸Œæœ›ä½ æ¯å¤©éƒ½èƒ½é‡è§å±äºä½ çš„å°ç¡®å¹¸ã€‚" },
            { t: "(8/9) ğŸˆ", c: "è°¢è°¢ä½ å‡ºç°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œ\næˆä¸ºæˆ‘ç‰¹åˆ«çš„æœ‹å‹ã€‚\nå¸Œæœ›åœ¨æœªæ¥çš„æ—¥å­é‡Œï¼Œ\næˆ‘ä»¬å¯ä»¥ç»§ç»­ä¸€èµ·å¤§ç¬‘ï¼Œä¸€èµ·å¯å¯çˆ±çˆ±ã€‚" },
            { t: "(9/9) ğŸ„", c: "æœ€åï¼Œ\näº²çˆ±çš„å°èƒ¡åŒå­¦ï¼Œ\næ„¿ä½ æ°¸è¿œè¢«çˆ±åŒ…å›´ï¼Œä¸‡äº‹èƒœæ„ï¼\nåœ£è¯å¿«ä¹ï¼Œä¸æ­¢åœ£è¯ï¼Œæ¯å¤©éƒ½å¿«ä¹ï¼" }
        ];
  
        // ================= ç³»ç»Ÿå˜é‡ =================  
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        let currentMemIndex = 0;

        // ================= åˆå§‹åŒ– =================  
        window.onload = async () => {
            // ç­‰å¾…å­—ä½“åŠ è½½
            await document.fonts.ready;
            
            // éšè—Loading
            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 800);

            // æ˜¾ç¤ºåºç« 
            showStage('stage-0-intro');
            
            // 500msåå¼€å§‹æ‰“å­—
            setTimeout(() => {
                typeWriter(document.getElementById('intro-text'), INTRO_TEXT, () => {
                    enableBtn('btn-intro');
                });
            }, 800);

            // å¯åŠ¨é›ªèŠ±
            setInterval(createSnow, 200);
        };

        // ================= åŠŸèƒ½å‡½æ•° =================  

        // 1. åœºæ™¯åˆ‡æ¢ç®¡ç†
        function showStage(id) {
            // éšè—æ‰€æœ‰æ´»åŠ¨åœºæ™¯
            document.querySelectorAll('.overlay-stage').forEach(el => {
                if(el.classList.contains('active')) {
                    el.classList.remove('active');
                    // è®©æ—§åœºæ™¯è‡ªç„¶æ·¡å‡º
                }
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 800); // ä¸CSS transitionæ—¶é—´åŒ¹é…
            });
            
            // æ˜¾ç¤ºç›®æ ‡åœºæ™¯
            const target = document.getElementById(id);
            target.style.display = 'flex'; 
            // å¼ºåˆ¶é‡ç»˜
            target.offsetHeight; 
            target.classList.add('active');
        }

        // 2. æ‰“å­—æœºæ•ˆæœ
        function typeWriter(element, text, onComplete) {
            element.innerHTML = ""; // æ¸…ç©º
            element.classList.add('typing-cursor'); // æ˜¾ç¤ºå…‰æ ‡
            let i = 0;
            const speed = 50; // æ‰“å­—é€Ÿåº¦ ms

            function type() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.innerHTML += (char === '\n' ? '<br>' : char);
                    i++;
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    element.parentElement.scrollTop = element.parentElement.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('typing-cursor'); // ç§»é™¤å…‰æ ‡
                    if (onComplete) onComplete();
                }
            }
            type();
        }

        function enableBtn(id) {
            const btn = document.getElementById(id);
            btn.classList.remove('disabled');
        }

        // 3. éŸ³ä¹æ§åˆ¶ (å¸¦æ·¡å…¥æ•ˆæœ)
        function toggleMusic(e) {
            e.stopPropagation();
            if (bgm.paused) {
                playBgm();
            } else {
                bgm.pause();
                musicBtn.classList.remove('playing');
                musicBtn.innerText = 'ğŸš«';
            }
        }

        function playBgm() {
            bgm.volume = 0;
            bgm.play().then(() => {
                musicBtn.classList.add('playing');
                musicBtn.innerText = 'ğŸµ';
                // æ·¡å…¥
                let vol = 0;
                const fade = setInterval(() => {
                    vol += 0.05;
                    if (vol >= 0.6) {
                        clearInterval(fade);
                        bgm.volume = 0.6;
                    } else {
                        bgm.volume = vol;
                    }
                }, 200);
            }).catch(e => {
                console.log("Wait for interaction");
                musicBtn.innerText = 'ğŸš«';
            });
        }

        // ================= ä¸šåŠ¡é€»è¾‘ =================  

        // é˜¶æ®µ 1: å¼€å¯å›å¿†
        function startMemories() {
            playBgm(); // å°è¯•æ’­æ”¾éŸ³ä¹
            showStage('stage-1-memory');
            renderMemory(0);
        }

        function renderMemory(index) {
            currentMemIndex = index;
            const data = MEMORIES[index];
            const titleEl = document.getElementById('mem-title');
            const textEl = document.getElementById('mem-text');
            const btn = document.getElementById('btn-mem');

            // ç®€å•çš„æ·¡å…¥æ•ˆæœé‡ç½®
            textEl.style.opacity = '0.5';
            setTimeout(()=> textEl.style.opacity = '1', 100);

            titleEl.innerText = `Memories ${data.t}`;
            btn.classList.add('disabled'); // ç¦ç”¨æŒ‰é’®ç›´åˆ°æ‰“å­—å®Œæˆ

            typeWriter(textEl, data.c, () => {
                enableBtn('btn-mem');
            });
        }

        function nextMemory() {
            if (currentMemIndex < MEMORIES.length - 1) {
                renderMemory(currentMemIndex + 1);
            } else {
                // å›å¿†ç»“æŸï¼Œè¿›å…¥ Invite
                showStage('stage-2-invite');
                setTimeout(() => {
                    typeWriter(document.getElementById('invite-text'), INVITE_TEXT, () => {
                        enableBtn('btn-invite');
                    });
                }, 500);
            }
        }

        // é˜¶æ®µ 2: æ’­æ”¾å¿ƒå½¢åŠ¨ç”» (6.6s æ…¢é€Ÿç‰ˆ)
        function startHeartAnimation() {
            // æ˜¾å¼ç§»é™¤ Invite é˜¶æ®µï¼Œè§¦å‘ CSS fade-out åŠ¨ç”»
            const inviteStage = document.getElementById('stage-2-invite');
            inviteStage.classList.remove('active');
            
            const layer = document.getElementById('game-layer');
            layer.style.display = 'block'; // ç¡®ä¿å±‚å¯è§

            const w = window.innerWidth;
            const h = window.innerHeight;
            const cx = w / 2;
            const cy = h / 2;

            // åŠ¨æ€è®¡ç®—å¿ƒå½¢å°ºå¯¸
            const minDim = Math.min(w, h);
            const scale = minDim < 400 ? 11 : (minDim < 600 ? 14 : 18); 
            
            // è®¡ç®—å»¶è¿Ÿï¼šç¡®ä¿æ€»æ—¶é•¿çº¦ä¸º 6.6 ç§’
            // 24ä¸ªæ–¹å—ï¼Œå»¶è¿Ÿç´¯åŠ 
            const delay = 250; 

            MESSAGES.forEach((msg, i) => {
                const t = (i / MESSAGES.length) * 2 * Math.PI;
                // å¿ƒå½¢æ–¹ç¨‹
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                // åº”ç”¨ç¼©æ”¾
                const targetX = (x * scale + cx) - 30;
                const targetY = (y * scale + cy) - 30;

                const box = document.createElement('div');
                box.className = 'msg-box';
                box.innerText = msg;
                
                // åˆå§‹ä½ç½®ï¼šå±å¹•æ­£ä¸­å¿ƒï¼Œä¸å¯è§
                box.style.left = (cx - 30) + 'px';
                box.style.top = (cy - 30) + 'px';
                
                layer.appendChild(box);
                
                // å¼ºåˆ¶å›æµ
                box.offsetHeight;

                // å‡åŒ€çš„å»¶è¿Ÿè§¦å‘ï¼Œå½¢æˆä¸æ»‘çš„é£å‡ºæ•ˆæœ
                setTimeout(() => {
                    box.style.left = targetX + 'px';
                    box.style.top = targetY + 'px';
                    box.style.opacity = '1';
                    box.style.transform = 'scale(1)';
                }, i * delay); 
            });

            // åŠ¨ç”»å…¨éƒ¨æ’­æ”¾å®Œæ¯•åï¼Œåœç•™2.5ç§’ï¼Œç„¶åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
            const totalTime = (MESSAGES.length - 1) * delay + 1000 + 2500;
            setTimeout(() => {
                finishGame();
            }, totalTime);
        }

        function finishGame() {
            document.getElementById('game-layer').style.display = 'none';
            showStage('stage-3-card');
        }

        // é˜¶æ®µ 3: æœ€ç»ˆé¡µé¢ (æ‹†å¼€ç¤¼ç‰©)
        function revealFinal() {
            const cardStage = document.getElementById('stage-3-card');
            cardStage.classList.remove('active'); // è§¦å‘ CSS é€€å‡ºåŠ¨ç”» (scale down)
            
            // è§¦å‘ç™½å±é—ªå…‰
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = '1';

            // åœ¨é—ªå…‰æœ€äº®æ—¶åˆ‡æ¢åœºæ™¯
            setTimeout(() => {
                cardStage.style.display = 'none';
                
                const mainScene = document.getElementById('main-scene');
                mainScene.classList.add('active');
                
                // é—ªå…‰æ·¡å‡ºï¼Œæ˜¾éœ²æœ€ç»ˆåœºæ™¯
                setTimeout(() => {
                    flash.style.opacity = '0';
                }, 100);
            }, 800); // ç­‰å¾…å¡ç‰‡é€€å‡ºåŠ¨ç”»å¤§åŠéƒ¨åˆ†
        }

        // ================= è§†è§‰ç‰¹æ•ˆ =================  
        function createSnow() {
            const c = document.getElementById('snow-container');
            if (c.childElementCount > 30) return; // é™åˆ¶æ•°é‡ä¼˜åŒ–æ€§èƒ½

            const s = document.createElement('div');
            s.classList.add('snowflake');
            const size = Math.random() * 8 + 5 + 'px';
            s.style.width = size; s.style.height = size;
            s.style.left = Math.random() * 100 + 'vw';
            s.style.opacity = Math.random() * 0.5 + 0.3;
            
            // éšæœºæ¨¡ç³Š
            if (Math.random() > 0.5) s.style.filter = 'blur(1px)';

            const d = Math.random() * 5 + 5 + 's';
            s.style.animation = `fall ${d} linear infinite`;
            c.appendChild(s);
            setTimeout(() => s.remove(), parseFloat(d) * 1000);
        }
    </script>  
</body>  
</html>
